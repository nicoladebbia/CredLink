<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variant Registry - C2PA Audit Tool</title>
    <meta name="description" content="Manage variant linking for C2PA manifests">
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'nonce-a1b2c3d4e5f6'; style-src 'self' 'unsafe-inline'; img-src 'self' data:;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <style nonce="a1b2c3d4e5f6">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .header p {
            color: #64748b;
            font-size: 14px;
        }

        .asset-selector {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #374151;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .variant-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .variant-panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .variant-panel h2 {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .variant-list {
            list-style: none;
        }

        .variant-item {
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .variant-item:hover {
            background: #f9fafb;
        }

        .variant-info {
            flex: 1;
        }

        .variant-pattern {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            margin-bottom: 4px;
        }

        .variant-mode {
            font-size: 12px;
            color: #6b7280;
        }

        .variant-actions {
            display: flex;
            gap: 6px;
        }

        .link-header {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 8px 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            color: #475569;
            margin-top: 8px;
            word-break: break-all;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .close-btn:hover {
            color: #374151;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-valid {
            background: #d1fae5;
            color: #065f46;
        }

        .status-invalid {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .empty-state svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #6b7280;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            z-index: 2000;
        }

        .toast.success {
            border-left: 4px solid #10b981;
        }

        .toast.error {
            border-left: 4px solid #ef4444;
        }

        .toast.warning {
            border-left: 4px solid #f59e0b;
        }

        @media (max-width: 768px) {
            .variant-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîó Variant Registry</h1>
            <p>Manage C2PA variant linking for renditions and derivatives</p>
        </div>

        <!-- Asset Selector -->
        <div class="asset-selector">
            <div class="form-group">
                <label for="assetId">Asset ID</label>
                <input type="text" id="assetId" placeholder="e.g., 1234, image_abc123" />
            </div>
            <button class="btn btn-primary" onclick="loadAssetVariants()">
                <span>üìÇ</span> Load Asset Variants
            </button>
        </div>

        <!-- Variant Grid -->
        <div class="variant-grid">
            <!-- Renditions Panel -->
            <div class="variant-panel">
                <h2>
                    <span>üîÑ</span> Renditions (Same Manifest)
                </h2>
                <ul class="variant-list" id="renditionsList">
                    <li class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p>No renditions loaded</p>
                        <p style="font-size: 12px; margin-top: 4px;">Select an asset to view variants</p>
                    </li>
                </ul>
                <div style="margin-top: 16px;">
                    <button class="btn btn-success btn-sm" onclick="showAddRenditionModal()">
                        <span>‚ûï</span> Add Rendition
                    </button>
                </div>
            </div>

            <!-- Derivatives Panel -->
            <div class="variant-panel">
                <h2>
                    <span>üîß</span> Derivatives (Child Manifests)
                </h2>
                <ul class="variant-list" id="derivativesList">
                    <li class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p>No derivatives loaded</p>
                        <p style="font-size: 12px; margin-top: 4px;">Select an asset to view variants</p>
                    </li>
                </ul>
                <div style="margin-top: 16px;">
                    <button class="btn btn-success btn-sm" onclick="showAddDerivativeModal()">
                        <span>‚ûï</span> Add Derivative
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="showMakeChildFromCropModal()">
                        <span>‚úÇÔ∏è</span> Make Child from Crop
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Rendition Modal -->
    <div class="modal" id="addRenditionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Rendition Route</h3>
                <button class="close-btn" onclick="closeModal('addRenditionModal')">&times;</button>
            </div>
            <form onsubmit="addRendition(event)">
                <div class="form-group">
                    <label for="renditionPattern">Route Pattern</label>
                    <input type="text" id="renditionPattern" placeholder="/img/1234*" required />
                    <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
                        Use * for wildcard, e.g., /img/1234* or /_next/image?url=/img/1234&*
                    </small>
                </div>
                <div class="form-group">
                    <label for="renditionManifest">Manifest URL</label>
                    <input type="url" id="renditionManifest" placeholder="https://manifests.example.com/sha256/.../active.c2pa" required />
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addRenditionModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Rendition</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Derivative Modal -->
    <div class="modal" id="addDerivativeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Derivative Manifest</h3>
                <button class="close-btn" onclick="closeModal('addDerivativeModal')">&times;</button>
            </div>
            <form onsubmit="addDerivative(event)">
                <div class="form-group">
                    <label for="derivativeParent">Parent Manifest URL</label>
                    <input type="url" id="derivativeParent" placeholder="https://manifests.example.com/sha256/.../active.c2pa" required />
                </div>
                <div class="form-group">
                    <label for="derivativeAsset">Asset URL</label>
                    <input type="url" id="derivativeAsset" placeholder="https://cdn.example.com/img/1234?w=1600&fit=crop" required />
                </div>
                <div class="form-group">
                    <label for="derivativeAction">Action Type</label>
                    <select id="derivativeAction" required onchange="updateActionParameters()">
                        <option value="">Select action...</option>
                        <option value="c2pa.transcoded">Transcoded</option>
                        <option value="c2pa.cropped">Cropped</option>
                        <option value="c2pa.edited">Edited</option>
                        <option value="c2pa.placed">Placed (Overlay)</option>
                        <option value="c2pa.repackaged">Repackaged</option>
                    </select>
                </div>
                <div id="actionParameters"></div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addDerivativeModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Derivative</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Make Child from Crop Modal -->
    <div class="modal" id="makeChildFromCropModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Make Child from Crop</h3>
                <button class="close-btn" onclick="closeModal('makeChildFromCropModal')">&times;</button>
            </div>
            <form onsubmit="makeChildFromCrop(event)">
                <div class="form-group">
                    <label for="cropParent">Parent Manifest URL</label>
                    <input type="url" id="cropParent" placeholder="https://manifests.example.com/sha256/.../active.c2pa" required />
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cropLeft">Left (px)</label>
                        <input type="number" id="cropLeft" value="0" required />
                    </div>
                    <div class="form-group">
                        <label for="cropTop">Top (px)</label>
                        <input type="number" id="cropTop" value="0" required />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="cropWidth">Width (px)</label>
                        <input type="number" id="cropWidth" required />
                    </div>
                    <div class="form-group">
                        <label for="cropHeight">Height (px)</label>
                        <input type="number" id="cropHeight" required />
                    </div>
                </div>
                <div class="form-group">
                    <label for="cropAsset">Cropped Asset URL</label>
                    <input type="url" id="cropAsset" placeholder="https://cdn.example.com/img/1234_crop.jpg" required />
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('makeChildFromCropModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Cropped Child</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script nonce="a1b2c3d4e5f6">
        // Global state
        let currentAssetId = null;
        let variantData = {
            renditions: [],
            derivatives: []
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load from URL params if present
            const urlParams = new URLSearchParams(window.location.search);
            const assetId = urlParams.get('asset');
            if (assetId) {
                document.getElementById('assetId').value = assetId;
                loadAssetVariants();
            }
        });

        // Load asset variants
        async function loadAssetVariants() {
            const assetId = document.getElementById('assetId').value.trim();
            if (!assetId) {
                showToast('Please enter an asset ID', 'warning');
                return;
            }

            currentAssetId = assetId;
            showLoading(true);

            try {
                const response = await fetch(`/api/variants/${encodeURIComponent(assetId)}`);
                if (!response.ok) {
                    throw new Error(`Failed to load variants: ${response.statusText}`);
                }

                const data = await response.json();
                variantData = data;
                renderVariants();
                showToast(`Loaded variants for asset ${assetId}`, 'success');

            } catch (error) {
                console.error('Error loading variants:', error);
                showToast(`Failed to load variants: ${error.message}`, 'error');
                renderVariants(); // Show empty state
            } finally {
                showLoading(false);
            }
        }

        // Render variants
        function renderVariants() {
            renderRenditions();
            renderDerivatives();
        }

        // Render renditions
        function renderRenditions() {
            const container = document.getElementById('renditionsList');
            
            if (!variantData.renditions || variantData.renditions.length === 0) {
                container.innerHTML = `
                    <li class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p>No renditions</p>
                        <p style="font-size: 12px; margin-top: 4px;">Add rendition routes to link to the same manifest</p>
                    </li>
                `;
                return;
            }

            container.innerHTML = variantData.renditions.map(rendition => `
                <li class="variant-item">
                    <div class="variant-info">
                        <div class="variant-pattern">${escapeHtml(rendition.pattern)}</div>
                        <div class="variant-mode">Links to: ${escapeHtml(rendition.manifest_url)}</div>
                        <div class="link-header">${escapeHtml(rendition.link_header)}</div>
                    </div>
                    <div class="variant-actions">
                        <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${escapeHtml(rendition.link_header)}')">
                            üìã Copy
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="removeRendition('${escapeHtml(rendition.pattern)}')">
                            üóëÔ∏è
                        </button>
                    </div>
                </li>
            `).join('');
        }

        // Render derivatives
        function renderDerivatives() {
            const container = document.getElementById('derivativesList');
            
            if (!variantData.derivatives || variantData.derivatives.length === 0) {
                container.innerHTML = `
                    <li class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <p>No derivatives</p>
                        <p style="font-size: 12px; margin-top: 4px;">Create child manifests for material changes</p>
                    </li>
                `;
                return;
            }

            container.innerHTML = variantData.derivatives.map(derivative => `
                <li class="variant-item">
                    <div class="variant-info">
                        <div class="variant-pattern">${escapeHtml(derivative.child_manifest)}</div>
                        <div class="variant-mode">Actions: ${escapeHtml(derivative.actions.map(a => a.type).join(', '))}</div>
                        <div class="link-header">${escapeHtml(derivative.link_header)}</div>
                        <span class="status-badge ${derivative.valid ? 'status-valid' : 'status-invalid'}">
                            ${derivative.valid ? 'Valid' : 'Invalid'}
                        </span>
                    </div>
                    <div class="variant-actions">
                        <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('${escapeHtml(derivative.link_header)}')">
                            üìã Copy
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="viewLineage('${escapeHtml(derivative.child_manifest)}')">
                            üîç Lineage
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="removeDerivative('${escapeHtml(derivative.child_manifest)}')">
                            üóëÔ∏è
                        </button>
                    </div>
                </li>
            `).join('');
        }

        // Modal functions
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showAddRenditionModal() {
            if (!currentAssetId) {
                showToast('Please select an asset first', 'warning');
                return;
            }
            showModal('addRenditionModal');
        }

        function showAddDerivativeModal() {
            if (!currentAssetId) {
                showToast('Please select an asset first', 'warning');
                return;
            }
            showModal('addDerivativeModal');
        }

        function showMakeChildFromCropModal() {
            if (!currentAssetId) {
                showToast('Please select an asset first', 'warning');
                return;
            }
            showModal('makeChildFromCropModal');
        }

        // Update action parameters based on action type
        function updateActionParameters() {
            const actionType = document.getElementById('derivativeAction').value;
            const container = document.getElementById('actionParameters');
            
            if (!actionType) {
                container.innerHTML = '';
                return;
            }

            let parametersHtml = '<div class="form-group"><label>Parameters</label>';
            
            switch (actionType) {
                case 'c2pa.transcoded':
                    parametersHtml += `
                        <div class="form-row">
                            <input type="text" id="transcodeFrom" placeholder="From format (e.g., image/jpeg)" required />
                            <input type="text" id="transcodeTo" placeholder="To format (e.g., image/webp)" required />
                        </div>
                        <input type="number" id="transcodeQuality" placeholder="Quality (0-100)" min="0" max="100" />
                    `;
                    break;
                    
                case 'c2pa.cropped':
                    parametersHtml += `
                        <div class="form-row">
                            <input type="number" id="cropLeft" placeholder="Left" value="0" required />
                            <input type="number" id="cropTop" placeholder="Top" value="0" required />
                        </div>
                        <div class="form-row">
                            <input type="number" id="cropWidth" placeholder="Width" required />
                            <input type="number" id="cropHeight" placeholder="Height" required />
                        </div>
                    `;
                    break;
                    
                case 'c2pa.edited':
                    parametersHtml += `
                        <input type="text" id="editDescription" placeholder="Description of edits" required />
                    `;
                    break;
                    
                case 'c2pa.placed':
                    parametersHtml += `
                        <input type="text" id="placeDescription" placeholder="Description of placement" required />
                    `;
                    break;
                    
                case 'c2pa.repackaged':
                    parametersHtml += `
                        <div class="form-row">
                            <input type="text" id="repackageFrom" placeholder="From container" required />
                            <input type="text" id="repackageTo" placeholder="To container" required />
                        </div>
                    `;
                    break;
            }
            
            parametersHtml += '</div>';
            container.innerHTML = parametersHtml;
        }

        // Form submissions
        async function addRendition(event) {
            event.preventDefault();
            
            const pattern = document.getElementById('renditionPattern').value;
            const manifestUrl = document.getElementById('renditionManifest').value;
            
            try {
                const response = await fetch('/api/variants/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        asset_id: currentAssetId,
                        manifest_url: manifestUrl,
                        variant_routes: [{ pattern }],
                        mode: 'rendition'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to add rendition: ${response.statusText}`);
                }
                
                const result = await response.json();
                showToast(`Added ${result.routes_instrumented} rendition route(s)`, 'success');
                closeModal('addRenditionModal');
                loadAssetVariants(); // Reload
                
            } catch (error) {
                showToast(`Failed to add rendition: ${error.message}`, 'error');
            }
        }

        async function addDerivative(event) {
            event.preventDefault();
            
            const parentManifest = document.getElementById('derivativeParent').value;
            const assetUrl = document.getElementById('derivativeAsset').value;
            const actionType = document.getElementById('derivativeAction').value;
            
            // Build action parameters
            const parameters = {};
            switch (actionType) {
                case 'c2pa.transcoded':
                    parameters.from = document.getElementById('transcodeFrom').value;
                    parameters.to = document.getElementById('transcodeTo').value;
                    if (document.getElementById('transcodeQuality').value) {
                        parameters.quality = parseInt(document.getElementById('transcodeQuality').value);
                    }
                    break;
                    
                case 'c2pa.cropped':
                    parameters.left = parseInt(document.getElementById('cropLeft').value);
                    parameters.top = parseInt(document.getElementById('cropTop').value);
                    parameters.width = parseInt(document.getElementById('cropWidth').value);
                    parameters.height = parseInt(document.getElementById('cropHeight').value);
                    break;
                    
                case 'c2pa.edited':
                    parameters.description = document.getElementById('editDescription').value;
                    break;
                    
                case 'c2pa.placed':
                    parameters.description = document.getElementById('placeDescription').value;
                    break;
                    
                case 'c2pa.repackaged':
                    parameters.from = document.getElementById('repackageFrom').value;
                    parameters.to = document.getElementById('repackageTo').value;
                    break;
            }
            
            try {
                const response = await fetch('/api/sign/derivative', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        parent_manifest: parentManifest,
                        asset_url: assetUrl,
                        relationship: 'parentOf',
                        actions: [{ type: actionType, parameters }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to create derivative: ${response.statusText}`);
                }
                
                const result = await response.json();
                showToast('Created derivative manifest successfully', 'success');
                closeModal('addDerivativeModal');
                loadAssetVariants(); // Reload
                
            } catch (error) {
                showToast(`Failed to create derivative: ${error.message}`, 'error');
            }
        }

        async function makeChildFromCrop(event) {
            event.preventDefault();
            
            const parentManifest = document.getElementById('cropParent').value;
            const assetUrl = document.getElementById('cropAsset').value;
            const left = parseInt(document.getElementById('cropLeft').value);
            const top = parseInt(document.getElementById('cropTop').value);
            const width = parseInt(document.getElementById('cropWidth').value);
            const height = parseInt(document.getElementById('cropHeight').value);
            
            try {
                const response = await fetch('/api/sign/derivative', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        parent_manifest: parentManifest,
                        asset_url: assetUrl,
                        relationship: 'parentOf',
                        actions: [{
                            type: 'c2pa.cropped',
                            parameters: { left, top, width, height }
                        }]
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to create cropped child: ${response.statusText}`);
                }
                
                const result = await response.json();
                showToast('Created cropped child manifest successfully', 'success');
                closeModal('makeChildFromCropModal');
                loadAssetVariants(); // Reload
                
            } catch (error) {
                showToast(`Failed to create cropped child: ${error.message}`, 'error');
            }
        }

        // Utility functions
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard', 'success');
            }).catch(() => {
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function viewLineage(manifestUrl) {
            window.open(`/verify/chain?manifest=${encodeURIComponent(manifestUrl)}`, '_blank');
        }

        async function removeRendition(pattern) {
            if (!confirm(`Remove rendition route "${pattern}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/variants/rendition/${encodeURIComponent(currentAssetId)}/${encodeURIComponent(pattern)}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to remove rendition: ${response.statusText}`);
                }
                
                showToast('Rendition removed successfully', 'success');
                loadAssetVariants(); // Reload
                
            } catch (error) {
                showToast(`Failed to remove rendition: ${error.message}`, 'error');
            }
        }

        async function removeDerivative(manifestUrl) {
            if (!confirm(`Remove derivative "${manifestUrl}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/variants/derivative/${encodeURIComponent(manifestUrl)}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to remove derivative: ${response.statusText}`);
                }
                
                showToast('Derivative removed successfully', 'success');
                loadAssetVariants(); // Reload
                
            } catch (error) {
                showToast(`Failed to remove derivative: ${error.message}`, 'error');
            }
        }

        function showLoading(show) {
            // Update UI to show loading state
            const buttons = document.querySelectorAll('button');
            buttons.forEach(btn => {
                if (show) {
                    btn.disabled = true;
                    btn.style.opacity = '0.6';
                } else {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            });
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è';
            toast.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
