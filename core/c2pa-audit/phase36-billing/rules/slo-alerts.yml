# Prometheus Alert Rules for C2PA Billing System SLOs
# Multi-window burn-rate alerting following Google SRE practices

groups:
  - name: c2pa-billing-slo-alerts
    interval: 1m
    rules:
      # Survival SLO - Remote (99.9% target, 0.1% error budget)
      # Critical burn rate: 14.4x for 1h (will exhaust budget in 5 hours)
      - alert: CriticalBurnRateRemoteSurvival1h
        expr: |
          (
            (1 - sum(rate(verify_ok_total{discovery="remote"}[1h])) / sum(rate(verify_total_total{discovery="remote"}[1h]))) 
            / 0.001
          ) >= 14.4
        for: 5m
        labels:
          severity: critical
          team: platform
          service: c2pa-billing
          slo: survival_remote_ratio
          window: 1h
          burn_rate: "14.4x"
        annotations:
          summary: "Critical burn rate detected for remote survival SLO"
          description: |
            Remote survival ratio burn rate is {{ $value | humanizePercentage }} over the last 1h.
            This will exhaust the monthly error budget in approximately 5 hours.
            
            Current burn rate: {{ $value | humanizePercentage }}
            Threshold: 14.4x
            Window: 1h
            SLO: 99.9% (0.1% error budget)
            
            Action: PAGE ON-CALL IMMEDIATELY
          runbook_url: "https://runbooks.c2pa.org/survival-slo-burn-rate"
          dashboard_url: "http://grafana:3000/d/c2pa-survival-overview"

      # High burn rate: 6x for 6h (will exhaust budget in 5 days)
      - alert: HighBurnRateRemoteSurvival6h
        expr: |
          (
            (1 - sum(rate(verify_ok_total{discovery="remote"}[6h])) / sum(rate(verify_total_total{discovery="remote"}[6h]))) 
            / 0.001
          ) >= 6.0
        for: 30m
        labels:
          severity: critical
          team: platform
          service: c2pa-billing
          slo: survival_remote_ratio
          window: 6h
          burn_rate: "6x"
        annotations:
          summary: "High burn rate detected for remote survival SLO"
          description: |
            Remote survival ratio burn rate is {{ $value | humanizePercentage }} over the last 6h.
            This will exhaust the monthly error budget in approximately 5 days.
            
            Current burn rate: {{ $value | humanizePercentage }}
            Threshold: 6x
            Window: 6h
            SLO: 99.9% (0.1% error budget)
            
            Action: PAGE ON-CALL IMMEDIATELY
          runbook_url: "https://runbooks.c2pa.org/survival-slo-burn-rate"
          dashboard_url: "http://grafana:3000/d/c2pa-survival-overview"

      # Moderate burn rate: 2x for 24h (will exhaust budget in 15 days)
      - alert: ModerateBurnRateRemoteSurvival24h
        expr: |
          (
            (1 - sum(rate(verify_ok_total{discovery="remote"}[24h])) / sum(rate(verify_total_total{discovery="remote"}[24h]))) 
            / 0.001
          ) >= 2.0
        for: 2h
        labels:
          severity: warning
          team: platform
          service: c2pa-billing
          slo: survival_remote_ratio
          window: 24h
          burn_rate: "2x"
        annotations:
          summary: "Moderate burn rate detected for remote survival SLO"
          description: |
            Remote survival ratio burn rate is {{ $value | humanizePercentage }} over the last 24h.
            This will exhaust the monthly error budget in approximately 15 days.
            
            Current burn rate: {{ $value | humanizePercentage }}
            Threshold: 2x
            Window: 24h
            SLO: 99.9% (0.1% error budget)
            
            Action: CREATE INCIDENT TICKET
          runbook_url: "https://runbooks.c2pa.org/survival-slo-burn-rate"
          dashboard_url: "http://grafana:3000/d/c2pa-survival-overview"

      # Survival SLO - Embed (95% target, 5% error budget)
      - alert: EmbedSurvivalSLOViolation
        expr: |
          sum(rate(verify_ok_total{discovery="embedded", path="preserve"}[30d])) / sum(rate(verify_total_total{discovery="embedded"}[30d])) < 0.95
        for: 1h
        labels:
          severity: warning
          team: platform
          service: c2pa-billing
          slo: survival_embed_ratio
        annotations:
          summary: "Embed survival SLO violation detected"
          description: |
            Embed survival ratio is {{ $value | humanizePercentage }} over the last 30d.
            This is below the SLO target of 95%.
            
            Current value: {{ $value | humanizePercentage }}
            Target: 95%
            Error budget consumed: {{ printf "%.2f" (mul (sub 0.95 $value) 20) }}%
            
            Action: INVESTIGATE AND CREATE TICKET IF NEEDED
          runbook_url: "https://runbooks.c2pa.org/embed-survival-slo"
          dashboard_url: "http://grafana:3000/d/c2pa-survival-overview"

  - name: c2pa-billing-latency-alerts
    interval: 1m
    rules:
      # Verify latency SLO (p95 < 600ms)
      - alert: VerifyLatencySLOViolation
        expr: |
          histogram_quantile(0.95, sum(rate(verify_latency_ms_bucket[30d])) by (le)) > 600
        for: 15m
        labels:
          severity: warning
          team: platform
          service: c2pa-billing
          slo: verify_latency_p95
        annotations:
          summary: "Verify latency SLO violation detected"
          description: |
            Verify API p95 latency is {{ $value }}ms over the last 30d.
            This exceeds the SLO target of 600ms.
            
            Current p95: {{ $value }}ms
            Target: 600ms
            Violation: {{ printf "%.1f" (sub $value 600) }}ms over target
            
            Action: INVESTIGATE PERFORMANCE DEGRADATION
          runbook_url: "https://runbooks.c2pa.org/verify-latency-slo"
          dashboard_url: "http://grafana:3000/d/c2pa-latency-errors"

      # Sign latency SLO - Embed (p95 < 800ms)
      - alert: SignEmbedLatencySLOViolation
        expr: |
          histogram_quantile(0.95, sum(rate(sign_latency_ms_bucket{sign_type="embed"}[30d])) by (le)) > 800
        for: 15m
        labels:
          severity: warning
          team: platform
          service: c2pa-billing
          slo: sign_latency_embed_p95
        annotations:
          summary: "Sign embed latency SLO violation detected"
          description: |
            Sign API p95 latency (embed) is {{ $value }}ms over the last 30d.
            This exceeds the SLO target of 800ms.
            
            Current p95: {{ $value }}ms
            Target: 800ms
            Violation: {{ printf "%.1f" (sub $value 800) }}ms over target
            
            Action: INVESTIGATE PERFORMANCE DEGRADATION
          runbook_url: "https://runbooks.c2pa.org/sign-latency-slo"
          dashboard_url: "http://grafana:3000/d/c2pa-latency-errors"

      # Sign latency SLO - Remote (p95 < 400ms)
      - alert: SignRemoteLatencySLOViolation
        expr: |
          histogram_quantile(0.95, sum(rate(sign_latency_ms_bucket{sign_type="remote"}[30d])) by (le)) > 400
        for: 15m
        labels:
          severity: warning
          team: platform
          service: c2pa-billing
          slo: sign_latency_remote_p95
        annotations:
          summary: "Sign remote latency SLO violation detected"
          description: |
            Sign API p95 latency (remote) is {{ $value }}ms over the last 30d.
            This exceeds the SLO target of 400ms.
            
            Current p95: {{ $value }}ms
            Target: 400ms
            Violation: {{ printf "%.1f" (sub $value 400) }}ms over target
            
            Action: INVESTIGATE PERFORMANCE DEGRADATION
          runbook_url: "https://runbooks.c2pa.org/sign-latency-slo"
          dashboard_url: "http://grafana:3000/d/c2pa-latency-errors"

      # TSA latency SLO (p95 < 300ms)
      - alert: TSALatencySLOViolation
        expr: |
          histogram_quantile(0.95, sum(rate(tsa_latency_ms_bucket[30d])) by (le, tsa_vendor)) > 300
        for: 10m
        labels:
          severity: critical
          team: platform
          service: c2pa-billing
          slo: tsa_latency_p95
          tsa_vendor: "{{ $labels.tsa_vendor }}"
        annotations:
          summary: "TSA latency SLO violation detected"
          description: |
            TSA p95 latency is {{ $value }}ms over the last 30d for vendor {{ $labels.tsa_vendor }}.
            This exceeds the SLO target of 300ms.
            
            Current p95: {{ $value }}ms
            Target: 300ms
            Vendor: {{ $labels.tsa_vendor }}
            Violation: {{ printf "%.1f" (sub $value 300) }}ms over target
            
            Action: PAGE ON-CALL - TSA PERFORMANCE CRITICAL
          runbook_url: "https://runbooks.c2pa.org/tsa-latency-slo"
          dashboard_url: "http://grafana:3000/d/c2pa-edge-storage"

  - name: c2pa-billing-error-rate-alerts
    interval: 1m
    rules:
      # Overall error rate SLO (< 1%)
      - alert: OverallErrorRateSLOViolation
        expr: |
          sum(rate(error_total{class!="4xx"}[30d])) / sum(rate(request_total[30d])) > 0.01
        for: 10m
        labels:
          severity: warning
          team: platform
          service: c2pa-billing
          slo: overall_error_rate
        annotations:
          summary: "Overall error rate SLO violation detected"
          description: |
            Overall error rate is {{ $value | humanizePercentage }} over the last 30d.
            This exceeds the SLO target of 1%.
            
            Current error rate: {{ $value | humanizePercentage }}
            Target: 1%
            Violation: {{ printf "%.2f" (sub $value 0.01) | humanizePercentage }} over target
            
            Action: INVESTIGATE ERROR SPIKE
          runbook_url: "https://runbooks.c2pa.org/error-rate-slo"
          dashboard_url: "http://grafana:3000/d/c2pa-latency-errors"

      # Verify failure rate SLO (< 0.5%)
      - alert: VerifyErrorRateSLOViolation
        expr: |
          sum(rate(verify_fail_total[30d])) / sum(rate(verify_total_total[30d])) > 0.005
        for: 10m
        labels:
          severity: warning
          team: platform
          service: c2pa-billing
          slo: verify_error_rate
        annotations:
          summary: "Verify error rate SLO violation detected"
          description: |
            Verify failure rate is {{ $value | humanizePercentage }} over the last 30d.
            This exceeds the SLO target of 0.5%.
            
            Current error rate: {{ $value | humanizePercentage }}
            Target: 0.5%
            Violation: {{ printf "%.2f" (sub $value 0.005) | humanizePercentage }} over target
            
            Action: INVESTIGATE VERIFICATION FAILURES
          runbook_url: "https://runbooks.c2pa.org/verify-error-rate-slo"
          dashboard_url: "http://grafana:3000/d/c2pa-latency-errors"

      # TSA error rate SLO (< 1%)
      - alert: TSAErrorRateSLOViolation
        expr: |
          sum(rate(tsa_error_total[30d])) by (tsa_vendor) / sum(rate(tsa_request_total[30d])) by (tsa_vendor) > 0.01
        for: 5m
        labels:
          severity: critical
          team: platform
          service: c2pa-billing
          slo: tsa_error_rate
          tsa_vendor: "{{ $labels.tsa_vendor }}"
        annotations:
          summary: "TSA error rate SLO violation detected"
          description: |
            TSA error rate is {{ $value | humanizePercentage }} over the last 30d for vendor {{ $labels.tsa_vendor }}.
            This exceeds the SLO target of 1%.
            
            Current error rate: {{ $value | humanizePercentage }}
            Target: 1%
            Vendor: {{ $labels.tsa_vendor }}
            Violation: {{ printf "%.2f" (sub $value 0.01) | humanizePercentage }} over target
            
            Action: PAGE ON-CALL - TSA FAILURES CRITICAL
          runbook_url: "https://runbooks.c2pa.org/tsa-error-rate-slo"
          dashboard_url: "http://grafana:3000/d/c2pa-edge-storage"

  - name: c2pa-billing-cache-alerts
    interval: 1m
    rules:
      # Cache hit ratio SLO (> 85%)
      - alert: CacheHitRatioSLOViolation
        expr: |
          sum(rate(cache_hit_total[30d])) / sum(rate(cache_request_total[30d])) < 0.85
        for: 30m
        labels:
          severity: warning
          team: platform
          service: c2pa-billing
          slo: cache_hit_ratio
        annotations:
          summary: "Cache hit ratio SLO violation detected"
          description: |
            Cache hit ratio is {{ $value | humanizePercentage }} over the last 30d.
            This is below the SLO target of 85%.
            
            Current hit ratio: {{ $value | humanizePercentage }}
            Target: 85%
            Violation: {{ printf "%.1f" (sub 0.85 $value) | humanizePercentage }} below target
            
            Action: INVESTIGATE CACHE PERFORMANCE
          runbook_url: "https://runbooks.c2pa.org/cache-hit-ratio-slo"
          dashboard_url: "http://grafana:3000/d/c2pa-edge-storage"

  - name: c2pa-billing-cost-alerts
    interval: 5m
    rules:
      # Log budget exhausted
      - alert: LogBudgetExhausted
        expr: |
          sum(rate(log_bytes_total[30d])) by (tenant_id) > 1073741824
        for: 1h
        labels:
          severity: warning
          team: platform
          service: c2pa-billing
          type: cost
          tenant_id: "{{ $labels.tenant_id }}"
        annotations:
          summary: "Log budget exhausted for tenant {{ $labels.tenant_id }}"
          description: |
            Tenant {{ $labels.tenant_id }} has exceeded the monthly log budget of 1GB.
            
            Current usage: {{ $value | humanizeBytes }}
            Budget: 1GB
            Overage: {{ printf "%.1f" (sub $value 1073741824) | humanizeBytes }}
            
            Action: CREATE TICKET AND CONTACT CUSTOMER
          runbook_url: "https://runbooks.c2pa.org/log-budget-exhausted"
          dashboard_url: "http://grafana:3000/d/c2pa-finance"

      # Unusual cost accrual
      - alert: UnusualCostAccrual
        expr: |
          sum(rate(cost_accrual_usd_total[1h])) by (tenant_id) > 10.0
        for: 30m
        labels:
          severity: warning
          team: platform
          service: c2pa-billing
          type: cost
          tenant_id: "{{ $labels.tenant_id }}"
        annotations:
          summary: "Unusual cost accrual detected for tenant {{ $labels.tenant_id }}"
          description: |
            Tenant {{ $labels.tenant_id }} is accruing costs at ${{ $value }}/hour.
            This is unusually high and may indicate a problem.
            
            Current rate: ${{ $value }}/hour
            Threshold: $10/hour
            
            Action: INVESTIGATE USAGE PATTERNS
          runbook_url: "https://runbooks.c2pa.org/unusual-cost-accrual"
          dashboard_url: "http://grafana:3000/d/c2pa-finance"

  - name: c2pa-billing-infrastructure-alerts
    interval: 1m
    rules:
      # Application down
      - alert: ApplicationDown
        expr: up{job="c2pa-billing"} == 0
        for: 1m
        labels:
          severity: critical
          team: platform
          service: c2pa-billing
          type: infrastructure
        annotations:
          summary: "C2PA Billing application is down"
          description: |
            The C2PA Billing application has been down for more than 1 minute.
            
            Instance: {{ $labels.instance }}
            Job: {{ $labels.job }}
            
            Action: PAGE ON-CALL IMMEDIATELY
          runbook_url: "https://runbooks.c2pa.org/application-down"
          dashboard_url: "http://grafana:3000/d/c2pa-survival-overview"

      # High memory usage
      - alert: HighMemoryUsage
        expr: |
          (process_resident_memory_bytes{job="c2pa-billing"} / 1024 / 1024) > 1024
        for: 15m
        labels:
          severity: warning
          team: platform
          service: c2pa-billing
          type: infrastructure
        annotations:
          summary: "High memory usage detected"
          description: |
            C2PA Billing application is using {{ $value }}MB of memory.
            This is above the 1GB threshold.
            
            Current usage: {{ $value }}MB
            Threshold: 1GB
            
            Action: INVESTIGATE MEMORY LEAK
          runbook_url: "https://runbooks.c2pa.org/high-memory-usage"
          dashboard_url: "http://grafana:3000/d/c2pa-survival-overview"

      # High CPU usage
      - alert: HighCPUUsage
        expr: |
          rate(process_cpu_seconds_total{job="c2pa-billing"}[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          team: platform
          service: c2pa-billing
          type: infrastructure
        annotations:
          summary: "High CPU usage detected"
          description: |
            C2PA Billing application is using {{ $value }}% CPU.
            This is above the 80% threshold.
            
            Current usage: {{ $value }}%
            Threshold: 80%
            
            Action: INVESTIGATE CPU BOTTLENECK
          runbook_url: "https://runbooks.c2pa.org/high-cpu-usage"
          dashboard_url: "http://grafana:3000/d/c2pa-survival-overview"
