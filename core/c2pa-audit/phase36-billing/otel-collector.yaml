# OpenTelemetry Collector Configuration
# Minimal, copy-paste ready configuration for C2PA Billing System

receivers:
  otlp:
    protocols:
      http:
        endpoint: 0.0.0.0:4318
        cors:
          allowed_origins:
            - "http://localhost:3000"
            - "https://*.c2pa.org"
          allowed_headers:
            - "*"
      grpc:
        endpoint: 0.0.0.0:4317

  prometheus:
    config:
      scrape_configs:
        - job_name: 'c2pa-billing'
          static_configs:
            - targets: ['localhost:9464']
          scrape_interval: 30s
          metrics_path: /metrics

processors:
  batch:
    timeout: 1s
    send_batch_size: 1024
    send_batch_max_size: 2048

  memory_limiter:
    limit_mib: 512
    spike_limit_mib: 128
    check_interval: 5s

  attributes/add_tenant:
    actions:
      - key: tenant.id
        from_attribute: http.request.header.x-tenant-id
        action: upsert
      - key: request.id
        from_attribute: http.request.header.x-request-id
        action: upsert
      - key: user.id
        from_attribute: http.request.header.x-user-id
        action: upsert

  attributes/add_service:
    actions:
      - key: service.name
        value: "c2pa-billing"
        action: upsert
      - key: service.namespace
        value: "c2pa"
        action: upsert
      - key: service.version
        value: "1.1.0"
        action: upsert
      - key: deployment.environment.name
        from_attribute: deployment_environment
        action: upsert

  transform/add_resource_attributes:
    error_mode: ignore
    log_statements:
      - context: resource
        statements:
          - set(attributes["k8s.pod.name"], resource["k8s.pod.name"])
          - set(attributes["k8s.namespace.name"], resource["k8s.namespace.name"])
          - set(attributes["k8s.deployment.name"], resource["k8s.deployment.name"])
          - set(attributes["k8s.node.name"], resource["k8s.node.name"])

  transform/standardize_logs:
    error_mode: ignore
    log_statements:
      - context: log
        statements:
          - set(body, body["message"]) where exists(body["message"])
          - delete_key(attributes, "message")
          - set(attributes["log.level"], body["level"]) where exists(body["level"])
          - delete_key(body, "level")
          - set(attributes["tenant_id"], body["tenant_id"]) where exists(body["tenant_id"])
          - delete_key(body, "tenant_id")
          - set(attributes["request_id"], body["request_id"]) where exists(body["request_id"])
          - delete_key(body, "request_id")
          - set(attributes["asset_id"], body["asset_id"]) where exists(body["asset_id"])
          - delete_key(body, "asset_id")
          - set(attributes["manifest_hash"], body["manifest_hash"]) where exists(body["manifest_hash"])
          - delete_key(body, "manifest_hash")
          - set(attributes["path_decision"], body["path_decision"]) where exists(body["path_decision"])
          - delete_key(body, "path_decision")
          - set(attributes["optimizer_vendor"], body["optimizer_vendor"]) where exists(body["optimizer_vendor"])
          - delete_key(body, "optimizer_vendor")
          - set(attributes["cache_hit"], body["cache_hit"]) where exists(body["cache_hit"])
          - delete_key(body, "cache_hit")
          - set(attributes["release_sha"], body["release_sha"]) where exists(body["release_sha"])
          - delete_key(body, "release_sha")
          - set(attributes["error.class"], body["error_class"]) where exists(body["error_class"])
          - delete_key(body, "error_class")
          # Drop PII if detected
          - delete_key(attributes, "email")
          - delete_key(attributes, "phone")
          - delete_key(attributes, "ssn")
          - delete_key(attributes, "credit_card")

  transform/add_exemplars:
    error_mode: ignore
    metric_statements:
      - include: ".*_latency_ms"
        statements:
          - set(exemplars, {"trace_id": span["trace_id"], "span_id": span["span_id"]}) where span["trace_id"] != nil

  tail_sampling:
    decision_wait: 5s
    num_traces: 100
    expected_new_traces_per_sec: 10
    policies:
      - name: errors
        type: status_code
        status_code: { status_codes: [ERROR] }
      - name: slow
        type: latency
        latency: { threshold_ms: 800, unit: ms }
      - name: critical_operations
        type: string_attribute
        string_attribute: { key: "operation.name", values: ["sign.asset", "verify.asset"] }
      - name: tenant_errors
        type: and
        and:
          - type: string_attribute
            string_attribute: { key: "tenant.id", enabled: true }
          - type: status_code
            status_code: { status_codes: [ERROR] }

  resource/add_cloud:
    actions:
      - key: cloud.provider
        value: aws
        action: upsert
      - key: cloud.region
        value: us-east-1
        action: upsert
      - key: cloud.availability_zone
        value: us-east-1a
        action: upsert

exporters:
  # OTLP HTTP exporter for traces and metrics
  otlphttp:
    endpoint: http://tempo:4318
    tls:
      insecure: true
    headers:
      x-tempo-api-key: ${TEMPO_API_KEY}

  # Prometheus exporter for metrics (local scraping)
  prometheus:
    endpoint: "0.0.0.0:9464"
    namespace: "c2pa"
    const_labels:
      environment: "${OTEL_DEPLOYMENT_ENVIRONMENT}"
      service: "c2pa-billing"

  # Loki exporter for logs
  loki:
    endpoint: http://loki:3100/loki/api/v1/push
    tls:
      insecure: true
    labels:
      service: "c2pa-billing"
      environment: "${OTEL_DEPLOYMENT_ENVIRONMENT}"
      tenant_id: "attributes[\"tenant_id\"]"
      level: "attributes[\"log.level\"]"

  # Debug exporter (for development)
  debug:
    verbosity: detailed

  # File exporter (backup)
  file:
    path: /tmp/otel-output.json
    rotation:
      max_megabytes: 100
      max_backups: 5

extensions:
  health_check:
    endpoint: 0.0.0.0:13133
  pprof:
    endpoint: 0.0.0.0:1777
  zpages:
    endpoint: 0.0.0.0:55679

service:
  extensions: [health_check, pprof, zpages]
  
  pipelines:
    traces:
      receivers: [otlp]
      processors: 
        - memory_limiter
        - attributes/add_tenant
        - attributes/add_service
        - transform/add_resource_attributes
        - batch
        - tail_sampling
      exporters: [otlphttp, debug]

    metrics:
      receivers: [otlp, prometheus]
      processors:
        - memory_limiter
        - attributes/add_tenant
        - attributes/add_service
        - transform/add_resource_attributes
        - transform/add_exemplars
        - batch
      exporters: [otlphttp, prometheus, debug]

    logs:
      receivers: [otlp]
      processors:
        - memory_limiter
        - attributes/add_tenant
        - attributes/add_service
        - transform/add_resource_attributes
        - transform/standardize_logs
        - batch
      exporters: [loki, debug]

  telemetry:
    logs:
      level: "info"
      development: false
      encoding: "json"
    metrics:
      address: 0.0.0.0:8888
    traces:
      propagators: [tracecontext, baggage, b3]

# Limits and timeouts
limits:
  # Configure collector limits
  otlp:
    max_request_body_size: 5242880  # 5MB
    timeout: 30s
