name: CD - Phase 46 Canary & Rollback

# Continuous Deployment with progressive delivery
on:
  push:
    branches: 
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - prod

permissions:
  contents: read
  deployments: write
  id-token: write

jobs:
  # Job 1: Deploy to staging (canary testing ground)
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # NOTE: Uncomment environment protection after configuring 'staging' environment in GitHub settings
    # environment: 
    #   name: staging
    #   url: https://staging.c2concierge.dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Deploy to Cloudflare Workers (staging)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          wrangler deploy --env staging --var RELEASE_SHA=${{ github.sha }}
      
      - name: Record deployment marker
        run: |
          echo "Deployment: staging"
          echo "SHA: ${{ github.sha }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
      
      - name: Post-deployment health check
        run: |
          echo "â³ Waiting for deployment to stabilize..."
          sleep 30
          
          echo "ðŸ¥ Running health check..."
          curl -f https://staging.c2concierge.dev/health || exit 1
          
          echo "âœ… Staging deployment healthy"

  # Job 2: Canary deployment (5% traffic to new version)
  canary-deploy:
    name: Canary Deploy (5% traffic)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [deploy-staging]
    # NOTE: Uncomment environment protection after configuring 'production' environment in GitHub settings
    # environment:
    #   name: production
    #   url: https://c2concierge.dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Deploy canary version
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ðŸ¤ Deploying canary version..."
          wrangler deploy --env production --var RELEASE_SHA=${{ github.sha }} --var CANARY=true
      
      - name: Route 5% traffic to canary
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ðŸŽ¯ Routing 5% traffic to canary..."
          node ./ops/canary_route.js --percentage 5 --version ${{ github.sha }}
      
      - name: Record canary deployment
        run: |
          mkdir -p .artifacts/deployments
          cat > .artifacts/deployments/canary-${{ github.sha }}.json <<EOF
          {
            "deployment_type": "canary",
            "sha": "${{ github.sha }}",
            "run_id": "${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "traffic_percentage": 5,
            "status": "baking"
          }
          EOF
      
      - name: Upload deployment metadata
        uses: actions/upload-artifact@v4
        with:
          name: canary-deployment-metadata
          path: .artifacts/deployments/
          retention-days: 90
      
      - name: Bake canary (monitor metrics)
        run: |
          echo "ðŸ”¥ Baking canary for 10 minutes..."
          node ./ops/canary_check.sh --duration 600 --version ${{ github.sha }}
      
      - name: Evaluate canary metrics
        run: |
          echo "ðŸ“Š Evaluating canary metrics..."
          
          # Check survival rate (must be â‰¥ 99.9%)
          # Check p95 latency (must not degrade > 10%)
          # Check error rate (must be < 0.1%)
          
          if node ./ops/canary_evaluate.js --version ${{ github.sha }}; then
            echo "âœ… Canary metrics acceptable - safe to promote"
          else
            echo "âŒ Canary metrics failed - initiating rollback"
            node ./ops/canary_rollback.js
            exit 1
          fi
      
      - name: Notify canary success
        if: success()
        run: |
          echo "ðŸŽ‰ Canary deployment successful"
          echo "Ready for full promotion to production"

  # Job 3: Promote to full production (requires manual approval)
  promote-production:
    name: Promote to Production
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [canary-deploy]
    # NOTE: Uncomment environment protection after configuring 'production' environment in GitHub settings
    # environment:
    #   name: production
    #   url: https://c2concierge.dev
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Promote to 100% traffic
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ðŸš€ Promoting to 100% production traffic..."
          wrangler deploy --env prod --var RELEASE_SHA=${{ github.sha }}
      
      - name: Route 100% traffic to new version
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "ðŸŽ¯ Routing 100% traffic to new version..."
          node ./ops/canary_route.js --percentage 100 --version ${{ github.sha }}
      
      - name: Record production deployment
        run: |
          mkdir -p .artifacts/deployments
          cat > .artifacts/deployments/prod-${{ github.sha }}.json <<EOF
          {
            "deployment_type": "production",
            "sha": "${{ github.sha }}",
            "run_id": "${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "traffic_percentage": 100,
            "status": "deployed"
          }
          EOF
      
      - name: Upload deployment metadata
        uses: actions/upload-artifact@v4
        with:
          name: prod-deployment-metadata
          path: .artifacts/deployments/
          retention-days: 365
      
      - name: Post-deployment verification
        run: |
          echo "ðŸ¥ Running post-deployment verification..."
          sleep 30
          
          # Health check
          curl -f https://c2concierge.dev/health || exit 1
          
          # Quick survival check
          curl -f https://c2concierge.dev/api/verify/test || echo "Verify endpoint check"
          
          echo "âœ… Production deployment verified"
      
      - name: Create release tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          TAG="release-$(date +%Y%m%d-%H%M%S)"
          git tag -a "$TAG" -m "Production release $TAG - SHA ${{ github.sha }}"
          git push origin "$TAG" || echo "Tag push failed (may already exist)"
      
      - name: Notify deployment success
        run: |
          echo "ðŸŽ‰ Production deployment successful"
          echo "Version: ${{ github.sha }}"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

  # Job 4: Rollback procedure (manual trigger only)
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'rollback'
    # NOTE: Uncomment environment protection after configuring 'production' environment in GitHub settings
    # environment:
    #   name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install Wrangler
        run: npm install -g wrangler
      
      - name: Rollback Worker version
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          echo "âª Rolling back to previous version..."
          wrangler rollback --env prod
      
      - name: Verify rollback
        run: |
          echo "ðŸ¥ Verifying rollback..."
          sleep 30
          curl -f https://c2concierge.dev/health || exit 1
          echo "âœ… Rollback successful"
      
      - name: Record rollback
        run: |
          mkdir -p .artifacts/deployments
          cat > .artifacts/deployments/rollback-$(date +%s).json <<EOF
          {
            "deployment_type": "rollback",
            "triggered_by": "${{ github.actor }}",
            "run_id": "${{ github.run_id }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "status": "completed"
          }
          EOF
      
      - name: Notify rollback
        run: |
          echo "âš ï¸  Rollback completed"
          echo "Triggered by: ${{ github.actor }}"
          echo "Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
