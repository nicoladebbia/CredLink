name: Bundle Size Monitor

on:
  pull_request:
    paths:
      - 'sdk/js/**'
    branches: [ main, develop ]
  push:
    paths:
      - 'sdk/js/**'
    branches: [ main ]
  workflow_dispatch:

jobs:
  bundle-size-check:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Needed for comparison with base branch

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: sdk/js/package-lock.json

      - name: Install dependencies
        working-directory: sdk/js
        run: npm ci

      - name: Build SDK
        working-directory: sdk/js
        run: npm run build

      - name: Run bundle size analysis
        id: size-analysis
        working-directory: sdk/js
        run: |
          echo "ðŸ” Running bundle size analysis..."
          npm run size-check > size-report.txt 2>&1
          echo "analysis<<EOF" >> $GITHUB_OUTPUT
          cat size-report.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate size comparison
        id: comparison
        working-directory: sdk/js
        run: |
          echo "ðŸ“Š Generating size comparison..."
          
          # Get current sizes
          npm run size-limit -- --json > current-sizes.json
          
          # Try to get base branch sizes for comparison
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git fetch origin ${{ github.base_ref }}
            git checkout origin/${{ github.base_ref }} -- . 2>/dev/null || true
            npm ci --silent 2>/dev/null || true
            npm run build --silent 2>/dev/null || true
            npm run size-limit -- --json > base-sizes.json 2>/dev/null || echo "{}" > base-sizes.json
            git checkout HEAD -- .
          else
            echo "{}" > base-sizes.json
          fi
          
          # Generate comparison
          node -e "
            const fs = require('fs');
            const current = JSON.parse(fs.readFileSync('current-sizes.json', 'utf8'));
            const base = JSON.parse(fs.readFileSync('base-sizes.json', 'utf8'));
            
            console.log('## ðŸ“¦ Bundle Size Comparison\\n');
            console.log('| Bundle | Current | Limit | Status | Change |');
            console.log('|--------|---------|-------|--------|--------|');
            
            current.forEach(bundle => {
              const baseBundle = base.find(b => b.path === bundle.path);
              const change = baseBundle ? bundle.size - baseBundle.size : 0;
              const changePercent = baseBundle ? ((change / baseBundle.size) * 100).toFixed(1) : 0;
              const changeSymbol = change > 0 ? 'ðŸ“ˆ' : change < 0 ? 'ðŸ“‰' : 'âž¡ï¸';
              const status = bundle.size <= bundle.limit ? 'âœ… OK' : 'âŒ EXCEEDED';
              
              console.log(\`| \${bundle.name || bundle.path} | \${bundle.size}B | \${bundle.limit}B | \${status} | \${changeSymbol} \${changePercent}% |\`);
            });
            
            console.log('\\n---');
            console.log('*Generated by bundle size monitoring workflow*');
          " > comparison.md
          
          echo "comparison<<EOF" >> $GITHUB_OUTPUT
          cat comparison.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Comment PR with size report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('sdk/js/comparison.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comparison
            });

      - name: Upload bundle analysis reports
        uses: actions/upload-artifact@v4
        with:
          name: bundle-reports
          path: |
            sdk/js/dist/bundle-analysis*.html
            sdk/js/dist/bundle-report.json
            sdk/js/.bundle-history.json
          retention-days: 30

      - name: Check size limits
        working-directory: sdk/js
        run: |
          echo "ðŸš¨ Checking bundle size limits..."
          
          # Run size-limit and check for failures
          if ! npm run size-limit; then
            echo "âŒ Bundle size limits exceeded!"
            echo ""
            echo "Please optimize the bundle sizes before merging."
            echo "Run 'npm run size-limit:why' locally to analyze what's contributing to bundle size."
            exit 1
          fi
          
          echo "âœ… All bundle sizes within limits"

      - name: Performance budget check
        working-directory: sdk/js
        run: |
          echo "ðŸ’° Checking performance budgets..."
          
          # Check if we're approaching limits (80% threshold)
          node -e "
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            try {
              const output = execSync('npm run size-limit -- --json', { encoding: 'utf8' });
              const bundles = JSON.parse(output);
              
              let warnings = [];
              
              bundles.forEach(bundle => {
                const percentUsed = (bundle.size / bundle.limit) * 100;
                if (percentUsed > 80) {
                  warnings.push(\`âš ï¸ \${bundle.name || bundle.path}: \${percentUsed.toFixed(1)}% of limit used\`);
                }
              });
              
              if (warnings.length > 0) {
                console.log('âš ï¸ Performance Budget Warnings:');
                warnings.forEach(w => console.log(w));
                console.log('');
                console.log('ðŸ’¡ Consider optimization soon to stay within budget');
              } else {
                console.log('âœ… All bundles well within performance budgets');
              }
            } catch (error) {
              console.log('âŒ Could not analyze performance budgets');
            }
          "

      - name: Generate bundle size badge
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ðŸ† Generating bundle size badge..."
          
          # Calculate total bundle size
          cd sdk/js
          TOTAL_SIZE=$(node -e "
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            try {
              const output = execSync('npm run size-limit -- --json', { encoding: 'utf8' });
              const bundles = JSON.parse(output);
              const total = bundles.reduce((sum, b) => sum + b.size, 0);
              console.log(Math.round(total / 1024)); // Convert to KB
            } catch (error) {
              console.log('0');
            }
          ")
          
          echo "Total bundle size: ${TOTAL_SIZE}KB"
          echo "bundle-size=${TOTAL_SIZE}" >> $GITHUB_OUTPUT

      - name: Update size metrics
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ðŸ“ˆ Updating size metrics..."
          # This could be extended to update a dashboard or metrics system
          echo "Bundle size metrics updated for main branch"

  bundle-analysis:
    name: Bundle Analysis Report
    runs-on: ubuntu-latest
    needs: bundle-size-check
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Download bundle reports
        uses: actions/download-artifact@v4
        with:
          name: bundle-reports
          path: reports/

      - name: Generate comprehensive report
        run: |
          echo "ðŸ“Š Generating comprehensive bundle analysis report..."
          
          cat << 'EOF' > bundle-analysis-summary.md
          # Bundle Size Analysis Report
          
          ## ðŸ“ˆ Executive Summary
          This report provides detailed analysis of the CredLink SDK bundle sizes and optimization recommendations.
          
          ## ðŸ“¦ Bundle Breakdown
          
          EOF
          
          if [ -f "reports/bundle-report.json" ]; then
            node -e "
              const fs = require('fs');
              const report = JSON.parse(fs.readFileSync('reports/bundle-report.json', 'utf8'));
              
              console.log('### Performance Metrics');
              console.log(\`- **Total Bundles**: \${report.summary.totalBundles}\`);
              console.log(\`- **Healthy Bundles**: \${report.summary.healthy} âœ…\`);
              console.log(\`- **Warning Bundles**: \${report.summary.warnings} âš ï¸\`);
              console.log(\`- **Critical Bundles**: \${report.summary.critical} âŒ\`);
              console.log(\`- **Total Size**: \${(report.summary.totalSize / 1024).toFixed(1)} KB\`);
              console.log(\`- **Usage**: \${((report.summary.totalSize / report.summary.totalLimit) * 100).toFixed(1)}%\`);
              console.log('');
              
              console.log('### Bundle Details');
              report.bundles.forEach(bundle => {
                const status = bundle.status === 'healthy' ? 'âœ…' : 
                              bundle.status === 'warning' ? 'âš ï¸' : 'âŒ';
                console.log(\`- \${status} **\${bundle.name}**: \${(bundle.size / 1024).toFixed(1)} KB / \${(bundle.limit / 1024).toFixed(1)} KB\`);
              });
            " >> bundle-analysis-summary.md
          fi
          
          echo "## ðŸŽ¯ Recommendations"
          echo ""
          echo "- Monitor bundle sizes closely with each PR"
          echo "- Use \`npm run size-limit:why\` to analyze size contributions"
          echo "- Consider code splitting for large features"
          echo "- Regular dependency audits to remove unused packages"
          echo "" >> bundle-analysis-summary.md

      - name: Upload analysis report
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis-report
          path: bundle-analysis-summary.md
          retention-days: 90
