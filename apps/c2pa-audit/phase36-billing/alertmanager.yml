# AlertManager Configuration for C2PA Billing System
# Routes alerts to appropriate channels with proper escalation

global:
  # SMTP configuration for email alerts
  smtp_smarthost: '${SMTP_HOST:-smtp.gmail.com:587}'
  smtp_from: '${SMTP_FROM:-alerts@c2pa.org}'
  smtp_auth_username: '${SMTP_USER}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: true

  # Slack webhook configuration
  slack_api_url: '${ALERT_SLACK_WEBHOOK_URL}'

  # PagerDuty configuration
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

  # Default templates
  templates:
    - '/etc/alertmanager/templates/*.tmpl'

# Inhibition rules to prevent alert spam
inhibit_rules:
  # Inhibit lower severity alerts if critical alert is firing
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service', 'tenant_id']

  # Inhibit component alerts if application is down
  - source_match:
      alertname: 'ApplicationDown'
    target_match_re:
      service: 'c2pa-billing'
    equal: ['service']

# Route configuration for alert routing
route:
  # Default receiver
  receiver: 'default'

  # Grouping configuration
  group_by: ['service', 'severity', 'team']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 12h

  # Routes for different alert types
  routes:
    # Critical alerts - immediate paging
    - match:
        severity: 'critical'
      receiver: 'pagerduty-critical'
      group_wait: 0s
      group_interval: 1m
      repeat_interval: 5m
      routes:
        # SLO critical burn rate alerts
        - match_re:
            alertname: '(CriticalBurnRate|HighBurnRate).*'
          receiver: 'pagerduty-slo-critical'
          group_wait: 0s
          group_interval: 30s
          repeat_interval: 2m
        # Infrastructure critical alerts
        - match:
            type: 'infrastructure'
          receiver: 'pagerduty-infra-critical'
          group_wait: 0s
          group_interval: 30s
          repeat_interval: 2m

    # Warning alerts - Slack notification
    - match:
        severity: 'warning'
      receiver: 'slack-warnings'
      group_wait: 1m
      group_interval: 10m
      repeat_interval: 6h
      routes:
        # SLO violations
        - match_re:
            alertname: '.*SLOViolation'
          receiver: 'slack-slo-warnings'
        # Cost alerts
        - match:
            type: 'cost'
          receiver: 'slack-cost-warnings'
          repeat_interval: 24h

    # Info alerts - email only
    - match:
        severity: 'info'
      receiver: 'email-info'
      group_wait: 5m
      group_interval: 30m
      repeat_interval: 24h

# Receivers for different notification channels
receivers:
  # Default receiver
  - name: 'default'
    email_configs:
      - to: 'alerts@c2pa.org'
        subject: '[C2PA] {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Runbook: {{ .Annotations.runbook_url }}
          Dashboard: {{ .Annotations.dashboard_url }}
          {{ end }}
    slack_configs:
      - channel: '#alerts'
        title: 'C2PA Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Runbook:* {{ .Annotations.runbook_url }}
          *Dashboard:* {{ .Annotations.dashboard_url }}
          {{ end }}

  # PagerDuty for critical alerts
  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: '${ALERT_PAGERDUTY_INTEGRATION_KEY}'
        description: '{{ .GroupLabels.alertname }} - {{ .GroupLabels.service }}'
        details:
          firing: '{{ .Alerts.Firing | len }}'
          resolved: '{{ .Alerts.Resolved | len }}'
          service: '{{ .GroupLabels.service }}'
          severity: '{{ .GroupLabels.severity }}'
          team: '{{ .GroupLabels.team }}'
        severity: 'critical'

  # PagerDuty for SLO critical alerts
  - name: 'pagerduty-slo-critical'
    pagerduty_configs:
      - service_key: '${ALERT_PAGERDUTY_INTEGRATION_KEY}'
        description: 'SLO CRITICAL: {{ .GroupLabels.alertname }}'
        details:
          firing: '{{ .Alerts.Firing | len }}'
          resolved: '{{ .Alerts.Resolved | len }}'
          service: '{{ .GroupLabels.service }}'
          slo: '{{ .GroupLabels.slo }}'
          window: '{{ .GroupLabels.window }}'
          burn_rate: '{{ .GroupLabels.burn_rate }}'
        severity: 'critical'
        class: 'SLO Violation'
        component: 'Observability'

  # PagerDuty for infrastructure critical alerts
  - name: 'pagerduty-infra-critical'
    pagerduty_configs:
      - service_key: '${ALERT_PAGERDUTY_INTEGRATION_KEY}'
        description: 'INFRA CRITICAL: {{ .GroupLabels.alertname }}'
        details:
          firing: '{{ .Alerts.Firing | len }}'
          resolved: '{{ .Alerts.Resolved | len }}'
          service: '{{ .GroupLabels.service }}'
          type: '{{ .GroupLabels.type }}'
        severity: 'critical'
        class: 'Infrastructure'
        component: 'Platform'

  # Slack for warning alerts
  - name: 'slack-warnings'
    slack_configs:
      - channel: '#warnings'
        title: 'C2PA Warning: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Warning:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Service:* {{ .GroupLabels.service }}
          *Severity:* {{ .GroupLabels.severity }}
          *Runbook:* {{ .Annotations.runbook_url }}
          *Dashboard:* {{ .Annotations.dashboard_url }}
          {{ end }}
        color: 'warning'
        send_resolved: true

  # Slack for SLO warnings
  - name: 'slack-slo-warnings'
    slack_configs:
      - channel: '#slo-warnings'
        title: 'SLO Warning: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *SLO Violation:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *SLO:* {{ .GroupLabels.slo }}
          *Service:* {{ .GroupLabels.service }}
          *Runbook:* {{ .Annotations.runbook_url }}
          *Dashboard:* {{ .Annotations.dashboard_url }}
          {{ end }}
        color: 'warning'
        send_resolved: true

  # Slack for cost warnings
  - name: 'slack-cost-warnings'
    slack_configs:
      - channel: '#cost-alerts'
        title: 'Cost Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Cost Alert:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Tenant:* {{ .GroupLabels.tenant_id }}
          *Service:* {{ .GroupLabels.service }}
          *Runbook:* {{ .Annotations.runbook_url }}
          *Dashboard:* {{ .Annotations.dashboard_url }}
          {{ end }}
        color: 'warning'
        send_resolved: true

  # Email for info alerts
  - name: 'email-info'
    email_configs:
      - to: 'team@c2pa.org'
        subject: '[C2PA Info] {{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          Alert: {{ .Annotations.summary }}
          Description: {{ .Annotations.description }}
          Service: {{ .GroupLabels.service }}
          Severity: {{ .GroupLabels.severity }}
          Runbook: {{ .Annotations.runbook_url }}
          Dashboard: {{ .Annotations.dashboard_url }}
          {{ end }}

# Time intervals for different alerting rules
time_intervals:
  - name: 'business-hours'
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '17:00'
        weekdays: ['monday:friday']
        location: 'US/Eastern'

  - name: 'after-hours'
    time_intervals:
      - times:
          - start_time: '17:01'
            end_time: '08:59'
        weekdays: ['monday:friday']
        location: 'US/Eastern'

  - name: 'weekends'
    time_intervals:
      - weekdays: ['saturday', 'sunday']
        location: 'US/Eastern'

# Mute timing configurations
mute_time_intervals:
  - name: 'maintenance-window'
    time_intervals:
      - start_time: '02:00'
        end_time: '04:00'
        weekdays: ['sunday']
        location: 'US/Eastern'

# Templates for custom alert formatting
templates:
  - '/etc/alertmanager/templates/c2pa.tmpl'
