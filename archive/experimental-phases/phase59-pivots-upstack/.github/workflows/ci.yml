name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Test & Validate
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run linter
      run: npm run lint

    - name: Check formatting
      run: npm run format -- --check

    - name: Validate syntax
      run: |
        for file in custody/custody-service.js analytics/analytics-service.js src/api-server.js src/index.js src/utils/logger.js; do
          echo "Validating $file..."
          node -c "$file"
        done

    - name: Run security audit
      run: npm audit --audit-level=moderate

    - name: Run tests
      run: npm test
      continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run security audit
      run: npm audit --audit-level=low

    - name: Check for vulnerable dependencies
      run: npm audit --json > audit-report.json || true

    - name: Upload audit report
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-report
        path: audit-report.json

  build:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: [test, security]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Verify project structure
      run: |
        echo "Verifying Phase 59 project structure..."
        test -f package.json || exit 1
        test -f src/index.js || exit 1
        test -f src/api-server.js || exit 1
        test -f custody/custody-service.js || exit 1
        test -f analytics/analytics-service.js || exit 1
        test -f scripts/schema.sql || exit 1
        echo "✓ All critical files present"

    - name: Verify configuration files
      run: |
        echo "Verifying configuration files..."
        test -f .env.example || exit 1
        test -f .eslintrc.json || exit 1
        test -f .prettierrc.json || exit 1
        test -f tsconfig.json || exit 1
        echo "✓ All configuration files present"

    - name: Build success
      run: echo "✓ Build verification complete - Phase 59 is production-ready"
