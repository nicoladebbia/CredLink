name: C2C Hostile CDN Gauntlet - Weekly Run

on:
  schedule:
    # Every Tuesday at 09:00 ET (14:00 UTC)
    - cron: '0 14 * * 2'
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Force run regardless of schedule'
        required: false
        type: boolean
        default: false

env:
  NODE_VERSION: '18'
  OUTPUT_DIR: './output'
  REPORTS_DIR: './docs/survival-reports'

jobs:
  run-gauntlet:
    name: Run CDN Gauntlet Tests
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Need full history for diffing

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: |
          cd gauntlet
          npm install

      - name: Build test URLs
        run: |
          cd gauntlet
          npm run build-urls

      - name: Run gauntlet tests
        run: |
          cd gauntlet
          npm run test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1

      - name: Generate HTML report
        run: |
          cd gauntlet
          npm run report

      - name: Analyze results and check for P0 incidents
        id: analyze
        run: |
          cd gauntlet
          
          # Extract metrics from summary
          REMOTE_RATE=$(jq -r '.remote_survival_rate' output/latest-summary.json)
          EMBED_RATE=$(jq -r '.embed_survival_rate' output/latest-summary.json)
          TOTAL_TESTS=$(jq -r '.total_tests' output/latest-summary.json)
          RUNTIME=$(jq -r '.performance.total_runtime' output/latest-summary.json)
          
          echo "remote_rate=$REMOTE_RATE" >> $GITHUB_OUTPUT
          echo "embed_rate=$EMBED_RATE" >> $GITHUB_OUTPUT
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "runtime=$RUNTIME" >> $GITHUB_OUTPUT
          
          # Check for P0 incident (remote survival < 99.9%)
          P0_THRESHOLD=99.9
          if (( $(echo "$REMOTE_RATE < $P0_THRESHOLD" | bc -l) )); then
            echo "p0_incident=true" >> $GITHUB_OUTPUT
            echo "üö® P0 INCIDENT DETECTED: Remote survival ${REMOTE_RATE}% < ${P0_THRESHOLD}%"
          else
            echo "p0_incident=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No P0 incident: Remote survival ${REMOTE_RATE}% ‚â• ${P0_THRESHOLD}%"
          fi

      - name: Compare with previous run
        id: diff
        run: |
          cd gauntlet
          
          # Get previous results
          PREVIOUS_FILE="output/previous-summary.json"
          CURRENT_FILE="output/latest-summary.json"
          
          if [ -f "$PREVIOUS_FILE" ]; then
            # Calculate differences
            PREVIOUS_REMOTE=$(jq -r '.remote_survival_rate' "$PREVIOUS_FILE")
            CURRENT_REMOTE=$(jq -r '.remote_survival_rate' "$CURRENT_FILE")
            REMOTE_DIFF=$(echo "$CURRENT_REMOTE - $PREVIOUS_REMOTE" | bc -l)
            
            PREVIOUS_EMBED=$(jq -r '.embed_survival_rate' "$PREVIOUS_FILE")
            CURRENT_EMBED=$(jq -r '.embed_survival_rate' "$CURRENT_FILE")
            EMBED_DIFF=$(echo "$CURRENT_EMBED - $PREVIOUS_EMBED" | bc -l)
            
            echo "previous_remote_rate=$PREVIOUS_REMOTE" >> $GITHUB_OUTPUT
            echo "remote_diff=$REMOTE_DIFF" >> $GITHUB_OUTPUT
            echo "previous_embed_rate=$PREVIOUS_EMBED" >> $GITHUB_OUTPUT
            echo "embed_diff=$EMBED_DIFF" >> $GITHUB_OUTPUT
            
            echo "üìä DIFF FROM PREVIOUS RUN:"
            echo "  Remote: ${PREVIOUS_REMOTE}% ‚Üí ${CURRENT_REMOTE}% (${REMOTE_DIFF}%)"
            echo "  Embed: ${PREVIOUS_EMBED}% ‚Üí ${CURRENT_EMBED}% (${EMBED_DIFF}%)"
          else
            echo "No previous results found - this is the first run"
            echo "previous_remote_rate=0" >> $GITHUB_OUTPUT
            echo "remote_diff=0" >> $GITHUB_OUTPUT
            echo "previous_embed_rate=0" >> $GITHUB_OUTPUT
            echo "embed_diff=0" >> $GITHUB_OUTPUT
          fi

      - name: Create P0 incident if needed
        if: steps.analyze.outputs.p0_incident == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const timestamp = new Date().toISOString().split('T')[0];
            
            const issueTitle = `üö® P0 INCIDENT: CDN Gauntlet Remote Survival Below Threshold - ${timestamp}`;
            const issueBody = `
            ## üö® P0 INCIDENT: CDN Gauntlet Failure
            
            **Run ID**: ${{ github.run_id }}
            **Timestamp**: ${timestamp}
            **Remote Survival**: ${{ steps.analyze.outputs.remote_rate }}% (threshold: 99.9%)
            **Embed Survival**: ${{ steps.analyze.outputs.embed_rate }}%
            **Total Tests**: ${{ steps.analyze.outputs.total_tests }}
            **Runtime**: ${{ steps.analyze.outputs.runtime }}ms
            
            ### üìä Metrics
            - **Current Remote Rate**: ${{ steps.analyze.outputs.remote_rate }}%
            - **Previous Remote Rate**: ${{ steps.diff.outputs.previous_remote_rate }}%
            - **Remote Rate Change**: ${{ steps.diff.outputs.remote_diff }}%
            - **Current Embed Rate**: ${{ steps.analyze.outputs.embed_rate }}%
            - **Previous Embed Rate**: ${{ steps.diff.outputs.previous_embed_rate }}%
            - **Embed Rate Change**: ${{ steps.diff.outputs.embed_diff }}%
            
            ### üéØ Immediate Actions Required
            1. **First 10 minutes**: Verify with retry - check for transient issues
            2. **20 minutes**: If still failing, force remote-only on affected paths
            3. **60 minutes**: Publish hotfix note and ship emergency fix
            
            ### üìã Runbook
            - [Check live report](https://docs.c2concierge.com/survival-reports/${timestamp}/)
            - [View detailed results](https://github.com/${owner}/${repo}/actions/runs/${{ github.run_id }})
            - [Emergency rollback procedure](https://runbooks.c2concierge.com/cdn-gauntlet-emergency)
            
            ### üîç Failed Tests
            <!-- Failed tests will be listed here by the next step -->
            
            ---
            
            **Assignee**: @c2c-on-call
            **Severity**: P0 - Critical
            **Impact**: Content Credentials verification failing across CDN providers
            **SLA**: 1-hour response time, 4-hour resolution
            
            <details>
            <summary>üìã Incident Checklist</summary>
            
            - [ ] Verify failure with manual testing
            - [ ] Check provider status pages
            - [ ] Review recent configuration changes
            - [ ] Engage provider support if needed
            - [ ] Implement emergency workaround
            - [ ] Schedule post-incident review
            
            </details>
            `;
            
            // Create the issue
            const issue = await github.rest.issues.create({
              owner,
              repo,
              title: issueTitle,
              body: issueBody,
              labels: ['incident', 'p0', 'cdn-gauntlet', 'automated'],
              assignees: ['c2c-on-call']
            });
            
            console.log(`Created P0 issue: #${issue.data.number}`);
            
            // Add to project board if needed
            try {
              await github.rest.projects.createCard({
                column_id: 'COLUMN_ID_HERE', // Replace with actual column ID
                content_id: issue.data.id,
                content_type: 'Issue'
              });
            } catch (error) {
              console.log('Could not add to project board:', error.message);
            }

      - name: List failed tests in issue
        if: steps.analyze.outputs.p0_incident == 'true'
        run: |
          cd gauntlet
          
          # Extract failed remote tests
          FAILED_TESTS=$(jq -r '.failures.remote[] | "- \(.provider)/\(.route)/\(.transform)/\(.asset): \(.why_remote)"' output/latest-summary.json)
          
          echo "Adding failed tests to issue..."
          
          # Add comment to the issue with failed tests
          FAILED_TESTS_COMMENT="### üîç Failed Remote Tests\n\n\`\`\`\n$FAILED_TESTS\n\`\`\`"
          
          echo "$FAILED_TESTS_COMMENT" > failed-tests-comment.md
          
          # Use GitHub CLI to add comment
          gh issue comment 1 --repo "$GITHUB_REPOSITORY" --file failed-tests-comment.md || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gauntlet-results-${{ github.run_number }}
          path: |
            gauntlet/output/
            gauntlet/docs/
          retention-days: 30

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./gauntlet/docs
          destination_dir: survival-reports

      - name: Update index page
        run: |
          cd gauntlet/docs
          
          # Create/update index.html to point to latest report
          TIMESTAMP=$(date +%Y-%m-%d)
          cat > index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <meta http-equiv="refresh" content="0; url=survival-reports/$TIMESTAMP/">
            <title>C2C CDN Gauntlet - Redirecting to Latest Report</title>
          </head>
          <body>
            <h1>Redirecting to latest CDN Gauntlet report...</h1>
            <p>If not redirected, <a href="survival-reports/$TIMESTAMP/">click here</a>.</p>
          </body>
          </html>
          EOF
          
          # Commit and push the updated index
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add index.html
          git commit -m "Update gauntlet index to $TIMESTAMP" || true
          git push

      - name: Notify Slack
        if: always()
        run: |
          cd gauntlet
          
          # Prepare Slack message
          REMOTE_RATE="${{ steps.analyze.outputs.remote_rate }}"
          EMBED_RATE="${{ steps.analyze.outputs.embed_rate }}"
          P0_INCIDENT="${{ steps.analyze.outputs.p0_incident }}"
          TIMESTAMP=$(date +%Y-%m-%d)
          
          if [ "$P0_INCIDENT" = "true" ]; then
            COLOR="danger"
            TITLE="üö® P0 INCIDENT: CDN Gauntlet Failure"
            TEXT="Remote survival: $REMOTE_RATE% (below 99.9% threshold)"
          else
            COLOR="good"
            TITLE="‚úÖ CDN Gauntlet Weekly Report"
            TEXT="Remote survival: $REMOTE_RATE%, Embed survival: $EMBED_RATE%"
          fi
          
          # Send to Slack (if webhook configured)
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"attachments\":[{\"color\":\"$COLOR\",\"title\":\"$TITLE\",\"text\":\"$TEXT\",\"title_link\":\"https://docs.c2concierge.com/survival-reports/$TIMESTAMP/\",\"fields\":[{\"title\":\"Run ID\",\"value\":\"${{ github.run_id }}\",\"short\":true},{\"title\":\"Total Tests\",\"value\":\"${{ steps.analyze.outputs.total_tests }}\",\"short\":true}]}]}" \
              "$SLACK_WEBHOOK" || true
          fi
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

      - name: Cleanup and prepare for next run
        run: |
          cd gauntlet
          
          # Move current results to previous for next comparison
          if [ -f "output/latest-summary.json" ]; then
            cp output/latest-summary.json output/previous-summary.json
            cp output/latest-results.json output/previous-results.json
          fi
          
          # Clean up old temp files
          find /tmp -name "gauntlet-*" -mtime +1 -delete || true

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run security scan
        run: |
          echo "Running security scan on gauntlet configuration..."
          # Add security scanning tools here
          npm audit --audit-level=high || true
