# Phase 6 - Optimizer Auto-Fallback: Cloudflare Worker Configuration
name = "c2-autofallback"
main = "worker.js"
compatibility_date = "2023-10-01"
compatibility_flags = ["nodejs_compat"]

[build]
command = "npm run build"

[build.upload]
format = "modules"
dir = "."
main = "worker.js"

# Production limits
[limits]
cpu_ms = 50000

# Durable Objects
[[durable_objects.bindings]]
name = "C2_AUTOFALLBACK"
class_name = "C2AutoFallbackDO"

# KV Namespaces - PRODUCTION IDs REQUIRED
[[kv_namespaces]]
binding = "C2_BREAKGLASS"
id = "PRODUCTION_BREAKGLASS_ID_HERE"
preview_id = "PREVIEW_BREAKGLASS_ID_HERE"

[[kv_namespaces]]
binding = "C2_POLICY_CACHE"
id = "PRODUCTION_POLICY_CACHE_ID_HERE"
preview_id = "PREVIEW_POLICY_CACHE_ID_HERE"

# R2 Bucket - PRODUCTION REQUIRED
[[r2_buckets]]
binding = "C2_INCIDENT_LOGS"
bucket_name = "c2-autofallback-incidents-prod"

# Environment Variables - PRODUCTION VALUES REQUIRED
[vars]
REMOTE_ONLY_DEFAULT = "0"
WINDOW_SECS = "60"
RESTORE_HYSTERESIS_SECS = "600"
ROUTE_MIN_SAMPLES = "40"
SCORE_THRESHOLD = "100"
SCORE_RESTORE = "30"
BADGE_REQUIRED = "1"
MANIFEST_BASE = "https://cdn.credlink.io/manifests"
TENANT_ID = "prod-tenant"

# Development variables (override in production)
[env.dev.vars]
REMOTE_ONLY_DEFAULT = "0"
WINDOW_SECS = "30"
RESTORE_HYSTERESIS_SECS = "120"
ROUTE_MIN_SAMPLES = "10"
SCORE_THRESHOLD = "50"
SCORE_RESTORE = "20"
BADGE_REQUIRED = "1"
MANIFEST_BASE = "https://manifests.dev.example"
TENANT_ID = "dev-tenant"

# Secrets (set via: wrangler secret put <NAME>)
# HMAC_SECRET = "your-hmac-secret-key"
# ADMIN_TOKEN = "your-admin-bearer-token"

# R2 Configuration for incident logs (optional)
[[r2_buckets]]
binding = "C2_INCIDENT_LOGS"
bucket_name = "c2-autofallback-incidents"

# Analytics Engine for metrics (optional)
[[analytics_engine_datasets]]
binding = "C2_ANALYTICS"

# D1 Database for configuration (optional)
[[d1_databases]]
binding = "C2_CONFIG_DB"
database_name = "c2-autofallback-config"
database_id = "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# Rate limiting for admin endpoints
[[routes]]
pattern = "your-domain.com/_c2/*"
zone_name = "your-domain.com"

# Custom domains for production
[env.production]
routes = [
  { pattern = "cdn.example.com/*", zone_name = "example.com" },
  { pattern = "images.example.com/*", zone_name = "example.com" }
]

[env.staging]
routes = [
  { pattern = "cdn-staging.example.com/*", zone_name = "example.com" }
]
