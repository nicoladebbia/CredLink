<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C2PA Audio Demo - End-to-End Verification</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #000;
            color: #fff;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.8;
            font-size: 16px;
        }
        
        .audio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .audio-card {
            background: #111;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #333;
            transition: all 0.2s ease;
        }
        
        .audio-card:hover {
            border-color: #007AFF;
            transform: translateY(-2px);
        }
        
        .audio-card h3 {
            margin: 0 0 15px 0;
            font-size: 18px;
            color: #007AFF;
        }
        
        .audio-card .format {
            display: inline-block;
            background: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .audio-player {
            width: 100%;
            margin-bottom: 15px;
            border-radius: 6px;
        }
        
        .audio-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 8px 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background: #0056D6;
        }
        
        .btn:disabled {
            background: #333;
            cursor: not-allowed;
        }
        
        .btn.secondary {
            background: #333;
        }
        
        .btn.secondary:hover {
            background: #444;
        }
        
        .verification-status {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
        }
        
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .status-row:last-child {
            margin-bottom: 0;
        }
        
        .status-label {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .status-value {
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-value.valid {
            color: #34C759;
        }
        
        .status-value.warning {
            color: #FF9500;
        }
        
        .status-value.invalid {
            color: #FF3B30;
        }
        
        .assertions {
            margin-top: 10px;
        }
        
        .assertion-tag {
            display: inline-block;
            background: #333;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 2px;
            font-size: 10px;
            font-family: monospace;
        }
        
        .waveform {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 15px;
            height: 80px;
            position: relative;
            overflow: hidden;
        }
        
        .waveform-canvas {
            width: 100%;
            height: 100%;
        }
        
        .spectral-view {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .spectral-image {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        
        .edit-info {
            background: #1a1a1a;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 12px;
        }
        
        .edit-info h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #FF9500;
        }
        
        .edit-detail {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
            opacity: 0.8;
        }
        
        .comparison-section {
            background: #111;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .comparison-section h2 {
            margin: 0 0 20px 0;
            font-size: 24px;
            text-align: center;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .comparison-item {
            text-align: center;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 8px;
        }
        
        .comparison-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #007AFF;
        }
        
        .comparison-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .comparison-desc {
            font-size: 12px;
            opacity: 0.7;
        }
        
        .performance-section {
            background: #111;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }
        
        .performance-section h2 {
            margin: 0 0 20px 0;
            font-size: 24px;
            text-align: center;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .metric-item {
            text-align: center;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 6px;
        }
        
        .metric-value {
            font-size: 20px;
            font-weight: 600;
            color: #34C759;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 11px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1a1a1a;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s ease;
        }
        
        .modal-close:hover {
            background: #333;
        }
        
        .manifest-viewer {
            background: #000;
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 11px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 400px;
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .audio-grid {
                grid-template-columns: 1fr;
            }
            
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>C2PA Audio Demo</h1>
            <p>End-to-end verification with WAV, FLAC, and MP3 formats</p>
        </header>

        <div class="audio-grid">
            <!-- WAV Original -->
            <div class="audio-card">
                <h3>WAV Original</h3>
                <span class="format">WAV • 48kHz • 24-bit • Uncompressed</span>
                
                <div class="waveform">
                    <canvas class="waveform-canvas" id="wav-waveform"></canvas>
                </div>
                
                <audio id="wav-player" class="audio-player" controls crossorigin="anonymous">
                    <source src="https://demo-cdn.c2pa.example.com/audio/sample.wav" type="audio/wav">
                </audio>
                
                <c2-badge-video id="wav-badge" player-id="wav-player" manifest-url="/manifests/demo-audio-wav.c2pa.json"></c2-badge-video>
                
                <div class="audio-controls">
                    <button class="btn" id="wav-play">Play</button>
                    <button class="btn secondary" id="wav-analyze">Analyze</button>
                    <button class="btn secondary" id="wav-details">View Details</button>
                </div>
                
                <div class="verification-status">
                    <div class="status-row">
                        <span class="status-label">Status:</span>
                        <span class="status-value" id="wav-status">Loading...</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Assertions:</span>
                        <span class="status-value" id="wav-assertions-count">0</span>
                    </div>
                    <div class="assertions" id="wav-assertions"></div>
                </div>
                
                <div class="edit-info">
                    <h4>Edit History</h4>
                    <div class="edit-detail">
                        <span>Type:</span>
                        <span>Original Recording</span>
                    </div>
                    <div class="edit-detail">
                        <span>Duration:</span>
                        <span>3:45</span>
                    </div>
                    <div class="edit-detail">
                        <span>Size:</span>
                        <span>25.6 MB</span>
                    </div>
                </div>
            </div>

            <!-- FLAC Archival -->
            <div class="audio-card">
                <h3>FLAC Archival</h3>
                <span class="format">FLAC • 48kHz • 24-bit • Lossless</span>
                
                <div class="waveform">
                    <canvas class="waveform-canvas" id="flac-waveform"></canvas>
                </div>
                
                <audio id="flac-player" class="audio-player" controls crossorigin="anonymous">
                    <source src="https://demo-cdn.c2pa.example.com/audio/sample.flac" type="audio/flac">
                </audio>
                
                <c2-badge-video id="flac-badge" player-id="flac-player" manifest-url="/manifests/demo-audio-flac.c2pa.json"></c2-badge-video>
                
                <div class="audio-controls">
                    <button class="btn" id="flac-play">Play</button>
                    <button class="btn secondary" id="flac-analyze">Analyze</button>
                    <button class="btn secondary" id="flac-details">View Details</button>
                </div>
                
                <div class="verification-status">
                    <div class="status-row">
                        <span class="status-label">Status:</span>
                        <span class="status-value" id="flac-status">Loading...</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Assertions:</span>
                        <span class="status-value" id="flac-assertions-count">0</span>
                    </div>
                    <div class="assertions" id="flac-assertions"></div>
                </div>
                
                <div class="edit-info">
                    <h4>Edit History</h4>
                    <div class="edit-detail">
                        <span>Type:</span>
                        <span>Lossless Compression</span>
                    </div>
                    <div class="edit-detail">
                        <span>Duration:</span>
                        <span>3:45</span>
                    </div>
                    <div class="edit-detail">
                        <span>Size:</span>
                        <span>12.8 MB</span>
                    </div>
                </div>
            </div>

            <!-- MP3 Distributed -->
            <div class="audio-card">
                <h3>MP3 Distributed</h3>
                <span class="format">MP3 • 44.1kHz • 320kbps • Lossy</span>
                
                <div class="waveform">
                    <canvas class="waveform-canvas" id="mp3-waveform"></canvas>
                </div>
                
                <audio id="mp3-player" class="audio-player" controls crossorigin="anonymous">
                    <source src="https://demo-cdn.c2pa.example.com/audio/sample.mp3" type="audio/mpeg">
                </audio>
                
                <c2-badge-video id="mp3-badge" player-id="mp3-player" manifest-url="/manifests/demo-audio-mp3.c2pa.json"></c2-badge-video>
                
                <div class="audio-controls">
                    <button class="btn" id="mp3-play">Play</button>
                    <button class="btn secondary" id="mp3-analyze">Analyze</button>
                    <button class="btn secondary" id="mp3-details">View Details</button>
                </div>
                
                <div class="verification-status">
                    <div class="status-row">
                        <span class="status-label">Status:</span>
                        <span class="status-value" id="mp3-status">Loading...</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Assertions:</span>
                        <span class="status-value" id="mp3-assertions-count">0</span>
                    </div>
                    <div class="assertions" id="mp3-assertions"></div>
                </div>
                
                <div class="edit-info">
                    <h4>Edit History</h4>
                    <div class="edit-detail">
                        <span>Type:</span>
                        <span>Trim + Compress</span>
                    </div>
                    <div class="edit-detail">
                        <span>Trim:</span>
                        <span>0:00 - 3:30 (15s trimmed)</span>
                    </div>
                    <div class="edit-detail">
                        <span>Size:</span>
                        <span>8.4 MB</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Section -->
        <div class="comparison-section">
            <h2>Format Comparison</h2>
            <div class="comparison-grid">
                <div class="comparison-item">
                    <div class="comparison-title">Quality</div>
                    <div class="comparison-value">WAV</div>
                    <div class="comparison-desc">Original uncompressed quality</div>
                </div>
                <div class="comparison-item">
                    <div class="comparison-title">Efficiency</div>
                    <div class="comparison-value">FLAC</div>
                    <div class="comparison-desc">50% size reduction, lossless</div>
                </div>
                <div class="comparison-item">
                    <div class="comparison-title">Compatibility</div>
                    <div class="comparison-value">MP3</div>
                    <div class="comparison-desc">Universal device support</div>
                </div>
                <div class="comparison-item">
                    <div class="comparison-title">Provenance</div>
                    <div class="comparison-value">All</div>
                    <div class="comparison-desc">C2PA verification maintained</div>
                </div>
            </div>
        </div>

        <!-- Performance Section -->
        <div class="performance-section">
            <h2>Performance Metrics</h2>
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-value" id="verify-time">0ms</div>
                    <div class="metric-label">Avg Verify Time</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="cache-hits">0</div>
                    <div class="metric-label">Cache Hits</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="total-verifications">0</div>
                    <div class="metric-label">Total Verifications</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" id="success-rate">100%</div>
                    <div class="metric-label">Success Rate</div>
                </div>
            </div>
        </div>

        <!-- Spectral Analysis -->
        <div class="spectral-view">
            <h3 style="margin: 0 0 15px 0;">Spectral Analysis (Cover Art)</h3>
            <img src="https://demo-cdn.c2pa.example.com/audio/spectral.png" alt="Spectral Analysis" class="spectral-image">
        </div>
    </div>

    <!-- Verification Modal -->
    <div class="modal" id="verify-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Audio Verification Details</h2>
                <button class="modal-close" id="modal-close">×</button>
            </div>
            <div id="modal-body">
                <div class="verification-status">
                    <div class="status-row">
                        <span class="status-label">Format:</span>
                        <span class="status-value" id="modal-format">Loading...</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Manifest URL:</span>
                        <span class="status-value" id="modal-manifest-url">Loading...</span>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Assertions:</span>
                        <span class="status-value" id="modal-assertions-count">Loading...</span>
                    </div>
                </div>
                
                <h3 style="margin: 20px 0 10px 0;">Active Assertions</h3>
                <div class="assertions" id="modal-assertions">Loading...</div>
                
                <h3 style="margin: 20px 0 10px 0;">Raw Manifest</h3>
                <div class="manifest-viewer" id="modal-manifest-json">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Fallback for missing components
        if (!customElements.get('c2-badge-video')) {
            console.warn('C2PA Badge component not loaded - using fallback');
            // Create a simple fallback badge
            customElements.define('c2-badge-video', class extends HTMLElement {
                constructor() {
                    super();
                    this.innerHTML = '<div style="background: #333; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">C2PA</div>';
                }
                
                getState() {
                    return { status: 'unknown', assertions: [], timestamp: Date.now() };
                }
                
                addEventListener() {}
            });
        }
    </script>
    <script src="/packages/badge-video/dist/index.js" onerror="console.warn('Badge component failed to load')"></script>
    <script>
        // Demo configuration
        const AUDIO_CONFIG = {
            formats: [
                {
                    id: 'wav',
                    name: 'WAV Original',
                    manifestUrl: '/manifests/demo-audio-wav.c2pa.json',
                    edits: ['original']
                },
                {
                    id: 'flac',
                    name: 'FLAC Archival',
                    manifestUrl: '/manifests/demo-audio-flac.c2pa.json',
                    edits: ['compress:lossless']
                },
                {
                    id: 'mp3',
                    name: 'MP3 Distributed',
                    manifestUrl: '/manifests/demo-audio-mp3.c2pa.json',
                    edits: ['trim:15s', 'compress:lossy']
                }
            ]
        };

        // Performance tracking
        const performanceMetrics = {
            verifyTimes: [],
            cacheHits: 0,
            totalVerifications: 0,
            successCount: 0
        };

        // Initialize demo
        function initializeDemo() {
            console.log('Initializing C2PA Audio Demo...');
            
            // Setup audio players and badges
            AUDIO_CONFIG.forEach(format => {
                setupAudioPlayer(format.id);
            });
            
            // Setup UI event listeners
            setupUIEventListeners();
            
            // Register service worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/packages/sw-relay/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            }
            
            // Initialize waveforms
            setTimeout(() => {
                initializeWaveforms();
            }, 1000);
            
            console.log('Audio demo initialization complete');
        }

        function setupAudioPlayer(formatId) {
            const player = document.getElementById(`${formatId}-player`);
            const badge = document.getElementById(`${formatId}-badge`);
            
            // Setup badge event listeners
            badge.addEventListener('c2-verify-update', (event) => {
                onAudioVerifyUpdate(formatId, event.detail);
            });
            
            badge.addEventListener('c2-verify-error', (event) => {
                onAudioVerifyError(formatId, event.detail);
            });
            
            badge.addEventListener('c2-show-verify-modal', (event) => {
                showAudioVerifyModal(formatId, event.detail);
            });
            
            // Setup player event listeners
            player.addEventListener('play', () => {
                document.getElementById(`${formatId}-play`).textContent = 'Pause';
                console.log(`${formatId.toUpperCase()} playback started`);
            });
            
            player.addEventListener('pause', () => {
                document.getElementById(`${formatId}-play`).textContent = 'Play';
                console.log(`${formatId.toUpperCase()} playback paused`);
            });
            
            player.addEventListener('timeupdate', () => {
                // Could add real-time waveform updates here
            });
        }

        function setupUIEventListeners() {
            // Play buttons
            AUDIO_CONFIG.forEach(format => {
                document.getElementById(`${format.id}-play`).addEventListener('click', () => {
                    toggleAudioPlayback(format.id);
                });
                
                document.getElementById(`${format.id}-analyze`).addEventListener('click', () => {
                    analyzeAudio(format.id);
                });
                
                document.getElementById(`${format.id}-details`).addEventListener('click', () => {
                    showAudioDetails(format.id);
                });
            });
            
            // Modal close
            document.getElementById('modal-close').addEventListener('click', closeModal);
            
            // Close modal on background click
            document.getElementById('verify-modal').addEventListener('click', (event) => {
                if (event.target === event.currentTarget) {
                    closeModal();
                }
            });
        }

        function toggleAudioPlayback(formatId) {
            const player = document.getElementById(`${formatId}-player`);
            const btn = document.getElementById(`${formatId}-play`);
            
            if (player.paused) {
                player.play();
                btn.textContent = 'Pause';
            } else {
                player.pause();
                btn.textContent = 'Play';
            }
        }

        function analyzeAudio(formatId) {
            console.log(`Analyzing ${formatId.toUpperCase()} audio...`);
            
            // Simulate audio analysis
            const player = document.getElementById(`${formatId}-player`);
            
            // Draw waveform
            drawWaveform(formatId);
            
            // Show analysis results
            alert(`${formatId.toUpperCase()} Analysis Complete\n\nDuration: ${formatDuration(player.duration)}\nSample Rate: ${formatId === 'mp3' ? '44.1kHz' : '48kHz'}\nBitrate: ${getBitrate(formatId)}\nFormat: ${getFormatName(formatId)}`);
        }

        function showAudioDetails(formatId) {
            const badge = document.getElementById(`${formatId}-badge`);
            const state = badge.getState();
            
            showAudioVerifyModal(formatId, state);
        }

        function onAudioVerifyUpdate(formatId, data) {
            const startTime = Date.now();
            
            // Update status display
            updateAudioStatus(formatId, data);
            
            // Track performance
            const verifyTime = Date.now() - startTime;
            performanceMetrics.verifyTimes.push(verifyTime);
            performanceMetrics.totalVerifications++;
            performanceMetrics.successCount++;
            
            updatePerformanceMetrics();
            
            console.log(`${formatId.toUpperCase()} verification update:`, data);
        }

        function onAudioVerifyError(formatId, data) {
            console.error(`${formatId.toUpperCase()} verification error:`, data);
            
            const statusElement = document.getElementById(`${formatId}-status`);
            statusElement.textContent = 'Error';
            statusElement.className = 'status-value invalid';
            
            document.getElementById(`${formatId}-assertions-count`).textContent = '0';
        }

        function updateAudioStatus(formatId, data) {
            const statusElement = document.getElementById(`${formatId}-status`);
            const assertionsCountElement = document.getElementById(`${formatId}-assertions-count`);
            const assertionsElement = document.getElementById(`${formatId}-assertions`);
            
            statusElement.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);
            statusElement.className = `status-value ${data.status}`;
            
            assertionsCountElement.textContent = data.assertions.length;
            
            if (data.assertions.length > 0) {
                assertionsElement.innerHTML = data.assertions
                    .map(assertion => `<span class="assertion-tag">${assertion}</span>`)
                    .join('');
            } else {
                assertionsElement.textContent = 'No assertions';
            }
        }

        function showAudioVerifyModal(formatId, state) {
            const modal = document.getElementById('verify-modal');
            const format = AUDIO_CONFIG.find(f => f.id === formatId);
            
            // Update modal content
            document.getElementById('modal-format').textContent = format.name;
            document.getElementById('modal-manifest-url').textContent = state.manifestUrl || 'Unknown';
            document.getElementById('modal-assertions-count').textContent = state.assertions.length;
            
            const assertionsDiv = document.getElementById('modal-assertions');
            if (state.assertions.length > 0) {
                assertionsDiv.innerHTML = state.assertions
                    .map(assertion => `<span class="assertion-tag">${assertion}</span>`)
                    .join('');
            } else {
                assertionsDiv.textContent = 'No assertions';
            }
            
            // Load and display manifest JSON
            if (state.manifestUrl) {
                fetch(state.manifestUrl)
                    .then(response => response.json())
                    .then(manifest => {
                        document.getElementById('modal-manifest-json').textContent = 
                            JSON.stringify(manifest, null, 2);
                    })
                    .catch(error => {
                        document.getElementById('modal-manifest-json').textContent = 
                            `Error loading manifest: ${error.message}`;
                    });
            }
            
            modal.classList.add('active');
        }

        function closeModal() {
            const modal = document.getElementById('verify-modal');
            modal.classList.remove('active');
        }

        function initializeWaveforms() {
            AUDIO_CONFIG.forEach(format => {
                drawWaveform(format.id);
            });
        }

        function drawWaveform(formatId) {
            const canvas = document.getElementById(`${formatId}-waveform`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth * 2;
            const height = canvas.height = canvas.offsetHeight * 2;
            
            // Clear canvas
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, width, height);
            
            // Generate fake waveform data
            const bars = 100;
            const barWidth = width / bars;
            
            ctx.fillStyle = formatId === 'wav' ? '#34C759' : 
                           formatId === 'flac' ? '#007AFF' : '#FF9500';
            
            for (let i = 0; i < bars; i++) {
                const barHeight = Math.random() * height * 0.8 + height * 0.1;
                const x = i * barWidth;
                const y = (height - barHeight) / 2;
                
                ctx.fillRect(x, y, barWidth - 2, barHeight);
            }
            
            // Scale down for retina displays
            canvas.style.width = (width / 2) + 'px';
            canvas.style.height = (height / 2) + 'px';
        }

        function updatePerformanceMetrics() {
            // Average verify time
            if (performanceMetrics.verifyTimes.length > 0) {
                const avgTime = performanceMetrics.verifyTimes.reduce((a, b) => a + b, 0) / 
                               performanceMetrics.verifyTimes.length;
                document.getElementById('verify-time').textContent = `${Math.round(avgTime)}ms`;
            }
            
            // Other metrics
            document.getElementById('cache-hits').textContent = performanceMetrics.cacheHits;
            document.getElementById('total-verifications').textContent = performanceMetrics.totalVerifications;
            
            // Success rate
            const successRate = performanceMetrics.totalVerifications > 0 ? 
                (performanceMetrics.successCount / performanceMetrics.totalVerifications * 100) : 100;
            document.getElementById('success-rate').textContent = `${Math.round(successRate)}%`;
        }

        // Utility functions
        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function getBitrate(formatId) {
            switch (formatId) {
                case 'wav': return '1411 kbps';
                case 'flac': return 'Variable (Lossless)';
                case 'mp3': return '320 kbps';
                default: return 'Unknown';
            }
        }

        function getFormatName(formatId) {
            switch (formatId) {
                case 'wav': return 'PCM Uncompressed';
                case 'flac': return 'Free Lossless Audio Codec';
                case 'mp3': return 'MPEG-1 Audio Layer III';
                default: return 'Unknown';
            }
        }

        // Initialize demo when page loads
        document.addEventListener('DOMContentLoaded', initializeDemo);
        
        // Global error handling
        window.addEventListener('error', (event) => {
            console.error('Audio demo error:', event.error);
        });
        
        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const perfData = performance.getEntriesByType('navigation')[0];
                    console.log('Page load time:', perfData.loadEventEnd - perfData.loadEventStart, 'ms');
                }, 0);
            });
        }
    </script>
</body>
</html>
