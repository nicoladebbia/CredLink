groups:
  - name: c2c-retro-sign.rules
    rules:
      # System Health Alerts
      - alert: C2CSystemDown
        expr: up{job="c2c-retro-sign"} == 0
        for: 1m
        labels:
          severity: critical
          service: c2c-retro-sign
        annotations:
          summary: "C2 Concierge Retro-Sign system is down"
          description: "Instance {{ $labels.instance }} has been down for more than 1 minute."

      - alert: C2CHighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 2m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} for instance {{ $labels.instance }}."

      - alert: C2CHighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2.0
        for: 5m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is {{ $value }}s for instance {{ $labels.instance }}."

      # Security Alerts
      - alert: C2CSecurityBreach
        expr: rate(security_events_total{severity="critical"}[1m]) > 0
        for: 0m
        labels:
          severity: critical
          service: c2c-retro-sign
        annotations:
          summary: "Critical security event detected"
          description: "Critical security events are occurring at rate {{ $value }} per second."

      - alert: C2CBruteForceAttack
        expr: rate(authentication_failure_total[1m]) > 10
        for: 1m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "Potential brute force attack"
          description: "Authentication failure rate is {{ $value }} per second."

      - alert: C2CLowAuthenticationSuccess
        expr: rate(authentication_success_total[5m]) / (rate(authentication_success_total[5m]) + rate(authentication_failure_total[5m])) < 0.8
        for: 3m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "Low authentication success rate"
          description: "Authentication success rate is {{ $value | humanizePercentage }}."

      # Performance Alerts
      - alert: C2CHighMemoryUsage
        expr: process_resident_memory_bytes / 1024 / 1024 > 1500
        for: 5m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}MB for instance {{ $labels.instance }}."

      - alert: C2CHighCPUUsage
        expr: rate(process_cpu_seconds_total[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}% for instance {{ $labels.instance }}."

      - alert: C2CConnectionPoolExhaustion
        expr: active_connections_total / connection_pool_limit > 0.9
        for: 2m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "Connection pool nearly exhausted"
          description: "Connection pool usage is {{ $value | humanizePercentage }}."

      - alert: C2CLowCacheHitRate
        expr: rate(cache_hits_total[5m]) / (rate(cache_hits_total[5m]) + rate(cache_misses_total[5m])) < 0.7
        for: 10m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }}."

      # Business Logic Alerts
      - alert: C2CProcessingQueueBacklog
        expr: processing_queue_size > 1000
        for: 5m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "Processing queue backlog"
          description: "Processing queue has {{ $value }} items pending."

      - alert: C2CSlowProcessing
        expr: rate(processing_operations_completed_total[5m]) < 10
        for: 5m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "Slow processing rate"
          description: "Processing rate is {{ $value }} operations per second."

      - alert: C2CStorageSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/app/data"} / node_filesystem_size_bytes{mountpoint="/app/data"}) < 0.1
        for: 5m
        labels:
          severity: critical
          service: c2c-retro-sign
        annotations:
          summary: "Low storage space"
          description: "Storage space is {{ $value | humanizePercentage }} full."

      # Circuit Breaker Alerts
      - alert: C2CCircuitBreakerOpen
        expr: circuit_breaker_state == 1
        for: 1m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "Circuit breaker is open"
          description: "Circuit breaker {{ $labels.breaker_name }} is open for instance {{ $labels.instance }}."

      # Database Alerts
      - alert: C2CDatabaseConnectionFailure
        expr: database_up == 0
        for: 1m
        labels:
          severity: critical
          service: c2c-retro-sign
        annotations:
          summary: "Database connection failure"
          description: "Cannot connect to database for instance {{ $labels.instance }}."

      - alert: C2CDatabaseSlowQueries
        expr: rate(database_slow_queries_total[5m]) > 5
        for: 3m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "Slow database queries"
          description: "Slow query rate is {{ $value }} per second."

      # Backup Alerts
      - alert: C2CBackupFailure
        expr: backup_success == 0
        for: 0m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "Backup failed"
          description: "Last backup failed for instance {{ $labels.instance }}."

      - alert: C2CBackupAge
        expr: time() - backup_last_success_timestamp > 172800  # 48 hours
        for: 0m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "Backup is too old"
          description: "Last successful backup was {{ $value | humanizeDuration }} ago."

      # Rate Limiting Alerts
      - alert: C2CRateLimitBreached
        expr: rate(rate_limit_exceeded_total[1m]) > 10
        for: 2m
        labels:
          severity: warning
          service: c2c-retro-sign
        annotations:
          summary: "Rate limit frequently exceeded"
          description: "Rate limit exceeded {{ $value }} times per second."
