{%- comment -%}
C2PA Pilot - Content Credentials for Shopify
14-day pilot implementation

REQUIRED THEME SETTINGS:
Add these to settings_schema.json in your theme:

{
  "name": "C2PA Pilot",
  "settings": [
    {
      "type": "text",
      "id": "c2pa_tenant_id",
      "label": "Tenant ID",
      "info": "Your C2PA tenant identifier"
    },
    {
      "type": "text",
      "id": "c2pa_tenant_domain",
      "label": "Tenant Domain",
      "info": "Your tenant domain for validation"
    },
    {
      "type": "text",
      "id": "c2pa_manifest_base",
      "label": "Manifest Base URL",
      "info": "Base URL where manifests are hosted"
    },
    {
      "type": "text",
      "id": "c2pa_api_endpoint",
      "label": "API Endpoint",
      "info": "C2PA API endpoint for tracking"
    },
    {
      "type": "text",
      "id": "c2pa_api_key",
      "label": "API Key",
      "info": "API key for authentication"
    },
    {
      "type": "text",
      "id": "c2pa_start_date",
      "label": "Pilot Start Date",
      "info": "Pilot start date for tracking"
    },
    {
      "type": "select",
      "id": "c2pa_badge_position",
      "label": "Badge Position",
      "options": [
        {"value": "top-left", "label": "Top Left"},
        {"value": "top-right", "label": "Top Right"},
        {"value": "bottom-left", "label": "Bottom Left"},
        {"value": "bottom-right", "label": "Bottom Right"}
      ],
      "default": "bottom-right"
    },
    {
      "type": "checkbox",
      "id": "c2pa_badge_hover",
      "label": "Show badge on hover only",
      "default": false
    }
  ]
}

Place this snippet in theme.liquid before </head>
{%- endcomment -%}

{%- if shop.permanent_domain contains settings.c2pa_tenant_domain -%}
  
  {%- comment -%}Inject C2PA Badge Script{%- endcomment -%}
  <script type="module" src="{{ 'c2-badge.esm.js' | asset_url }}" defer></script>
  <link rel="stylesheet" href="{{ 'c2-badge.css' | asset_url }}">
  
  {%- comment -%}Global Site Manifest Link{%- endcomment -%}
  {%- if settings.c2pa_manifest_base != blank -%}
    <link rel="c2pa-manifest" href="{{ settings.c2pa_manifest_base }}/shopify-manifest.jsonld">
  {%- endif -%}
  
  {%- comment -%}Product Page Manifest Injection{%- endcomment -%}
  {%- if template contains 'product' and product.featured_image -%}
    
    {%- assign c2pa_product_id = product.id | append: '-' | append: product.featured_image.id -%}
    {%- assign c2pa_manifest_url = settings.c2pa_manifest_base | append: '/products/' | append: c2pa_product_id | append: '.jsonld' -%}
    
    <link rel="c2pa-manifest" href="{{ c2pa_manifest_url }}">
    
    {%- comment -%}Product Schema with C2PA{%- endcomment -%}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "Product",
      "name": {{ product.title | json }},
      "image": [
        {{ product.featured_image | image_url: width: 2048 | json }}
      ],
      "description": {{ product.description | strip_html | json }},
      "sku": {{ product.selected_or_first_available_variant.sku | json }},
      "brand": {
        "@type": "Brand",
        "name": {{ shop.name | json }}
      },
      "c2pa": {
        "manifest": {{ c2pa_manifest_url | json }},
        "verified": true,
        "pilot": {
          "tenant": {{ settings.c2pa_tenant_id | json }},
          "start_date": {{ settings.c2pa_start_date | json }},
          "day": {{ "now" | date: "%d" | minus: settings.c2pa_start_date | date: "%d" | plus: 1 }}
        }
      }
    }
    </script>
    
  {%- endif -%}
  
  {%- comment -%}Collection Page Manifests{%- endcomment -%}
  {%- if template contains 'collection' -%}
    {%- for product in collection.products limit: 50 -%}
      {%- if product.featured_image -%}
        {%- assign c2pa_collection_id = product.id | append: '-' | append: product.featured_image.id -%}
        <link rel="c2pa-manifest" href="{{ settings.c2pa_manifest_base }}/collections/{{ c2pa_collection_id }}.jsonld">
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
  
  {%- comment -%}C2PA Badge Styling{%- endcomment -%}
  <style>
    .c2pa-badge {
      position: relative;
      display: inline-block;
    }
    
    .c2pa-badge img {
      position: relative;
      z-index: 1;
    }
    
    .c2pa-badge::after {
      content: '';
      position: absolute;
      bottom: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      background: url('{{ 'c2pa-icon.svg' | asset_url }}') no-repeat center;
      background-size: contain;
      z-index: 2;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }
    
    .c2pa-badge:hover::after {
      opacity: 1;
    }
    
    {%- if settings.c2pa_badge_position == 'top-left' -%}
      .c2pa-badge::after {
        top: 8px;
        left: 8px;
        bottom: auto;
        right: auto;
      }
    {%- elsif settings.c2pa_badge_position == 'top-right' -%}
      .c2pa-badge::after {
        top: 8px;
        right: 8px;
        bottom: auto;
        left: auto;
      }
    {%- elsif settings.c2pa_badge_position == 'bottom-left' -%}
      .c2pa-badge::after {
        bottom: 8px;
        left: 8px;
        top: auto;
        right: auto;
      }
    {%- endif -%}
    
    {%- comment -%}Product Page Specific Styling{%- endcomment -%}
    {%- if template contains 'product' -%}
      .product-single__media .c2pa-badge::after {
        width: 32px;
        height: 32px;
        bottom: 12px;
        right: 12px;
      }
    {%- endif -%}
    
    {%- comment -%}Mobile Optimization{%- endcomment -%}
    @media screen and (max-width: 768px) {
      .c2pa-badge::after {
        width: 20px;
        height: 20px;
        bottom: 6px;
        right: 6px;
      }
      
      .product-single__media .c2pa-badge::after {
        width: 24px;
        height: 24px;
        bottom: 8px;
        right: 8px;
      }
    }
  </style>
  
  {%- comment -%}C2PA Verification Modal{%- endcomment -%}
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize C2PA badges
    if (window.C2PABadge) {
      window.C2PABadge.init({
        manifestBase: '{{ settings.c2pa_manifest_base }}',
        tenantId: '{{ settings.c2pa_tenant_id }}',
        verifyUrl: 'https://verify.credlink.io',
        badgePosition: '{{ settings.c2pa_badge_position | default: "bottom-right" }}',
        showOnHover: {{ settings.c2pa_badge_hover | default: false }}
      });
    }
    
    // Track verification events for pilot metrics
    document.addEventListener('c2pa:verify', function(event) {
      const manifest = event.detail.manifest;
      const asset = event.detail.asset;
      
      // Send verification event to pilot dashboard
      fetch('{{ settings.c2paa_api_endpoint }}/verify', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer {{ settings.c2pa_api_key }}'
        },
        body: JSON.stringify({
          tenant_id: '{{ settings.c2pa_tenant_id }}',
          asset_url: asset,
          manifest_url: manifest,
          timestamp: new Date().toISOString(),
          user_agent: navigator.userAgent,
          page_type: '{{ template }}'
        })
      }).catch(function(error) {
        console.log('C2PA verification tracking failed:', error);
      });
    });
    
    // Auto-wrap product images with C2PA badge
    {%- if template contains 'product' -%}
    const productImages = document.querySelectorAll('.product-single__media img, .product-featured-img');
    productImages.forEach(function(img) {
      if (!img.closest('.c2pa-badge')) {
        const wrapper = document.createElement('div');
        wrapper.className = 'c2pa-badge';
        img.parentNode.insertBefore(wrapper, img);
        wrapper.appendChild(img);
      }
    });
    {%- endif -%}
  });
  </script>
  
{%- endif -%}

{%- comment -%}
Required Shopify Theme Settings:
- c2pa_tenant_id: Your tenant identifier
- c2pa_tenant_domain: Tenant domain for validation
- c2pa_manifest_base: Base URL for manifests
- c2pa_api_endpoint: API endpoint for tracking
- c2pa_api_key: API key for authentication
- c2pa_start_date: Pilot start date
- c2pa_badge_position: Badge position (top-left, top-right, bottom-left, bottom-right)
- c2pa_badge_hover: Show badge on hover only (true/false)

Installation Instructions:
1. Add this snippet to theme.liquid before </head>
2. Add the required theme settings in settings_schema.json
3. Upload c2-badge.esm.js and c2-badge.css to assets
4. Upload c2pa-icon.svg to assets
5. Configure theme settings in the theme customizer
{%- endcomment -%}
