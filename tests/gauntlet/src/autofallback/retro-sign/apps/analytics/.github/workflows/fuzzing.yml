name: Security Fuzzing

on:
  schedule:
    # Run fuzzing daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      duration:
        description: 'Fuzzing duration in minutes'
        required: false
        default: '30'
      target:
        description: 'Specific fuzz target to run'
        required: false
        default: 'all'

jobs:
  fuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
          
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build project
        run: npm run build
        
      - name: Setup fuzzing environment
        run: |
          mkdir -p security/fuzz/artifacts
          mkdir -p security/fuzz/corpus
          chmod +x security/runners/run_fuzz.ts
          
      - name: Run fuzzing tests
        run: |
          # Set fuzzing duration from input or default
          export FUZZ_DURATION=${{ github.event.inputs.duration || 30 }}
          echo "Running fuzzing for $FUZZ_DURATION minutes"
          
          # Run the fuzzing runner
          npm run security:fuzz || {
            echo "Fuzzing completed with issues"
            exit 1
          }
        env:
          RUST_BACKTRACE: 1
          RUST_LOG: debug
          
      - name: Upload fuzzing artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzzing-artifacts
          path: |
            security/fuzz/artifacts/
            security/fuzz/corpus/
          retention-days: 7
          
      - name: Generate fuzzing report
        if: always()
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          
          const artifactsDir = 'security/fuzz/artifacts';
          const reportPath = path.join(artifactsDir, 'fuzz_summary.json');
          
          let summary = {
            timestamp: new Date().toISOString(),
            workflow_run_id: '${{ github.run_id }}',
            repository: '${{ github.repository }}',
            branch: '${{ github.ref_name }}',
            commit: '${{ github.sha }}',
            duration_minutes: '${{ github.event.inputs.duration || 30 }}',
            status: '${{ job.status }}'
          };
          
          // Try to read detailed report if available
          try {
            const reports = fs.readdirSync(artifactsDir).filter(f => f.startsWith('fuzz_report_'));
            if (reports.length > 0) {
              const latestReport = reports.sort().pop();
              const detailedReport = JSON.parse(fs.readFileSync(path.join(artifactsDir, latestReport), 'utf8'));
              summary = { ...summary, ...detailedReport };
            }
          } catch (e) {
            console.log('No detailed report found, using basic summary');
          }
          
          fs.writeFileSync(reportPath, JSON.stringify(summary, null, 2));
          console.log('Fuzzing summary report generated');
          "
          
      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            try {
              const reportPath = 'security/fuzz/artifacts/fuzz_summary.json';
              const summary = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
              
              const comment = `
              ## üîç Security Fuzzing Results
              
              **Status**: ${summary.status === 'completed' && summary.summary?.failed_targets === 0 ? '‚úÖ PASSED' : '‚ùå FAILED'}
              
              **Summary**:
              - Targets: ${summary.summary?.passed_targets || 0}/${summary.summary?.total_targets || 0} passed
              - Executions: ${summary.summary?.total_executions || 0}
              - Crashes: ${summary.summary?.total_crashes || 0}
              - Hangs: ${summary.summary?.total_hangs || 0}
              - Coverage: ${summary.summary?.average_coverage?.toFixed(2) || 0}%
              
              **Artifacts**: Fuzzing artifacts are available in the workflow run.
              
              ---
              *Generated by Phase 16 Adversarial Lab v1*
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Failed to generate PR comment:', error);
            }
            
      - name: Check fuzzing thresholds
        if: always()
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          
          const reportPath = 'security/fuzz/artifacts/fuzz_summary.json';
          
          try {
            const summary = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            
            // Define failure thresholds
            const maxCrashes = 0;
            const maxHangs = 1;
            const minCoverage = 85;
            
            const crashes = summary.summary?.total_crashes || 0;
            const hangs = summary.summary?.total_hangs || 0;
            const coverage = summary.summary?.average_coverage || 0;
            
            console.log(\`Crashes: \${crashes} (threshold: \${maxCrashes})\`);
            console.log(\`Hangs: \${hangs} (threshold: \${maxHangs})\`);
            console.log(\`Coverage: \${coverage.toFixed(2)}% (threshold: \${minCoverage}%)\`);
            
            if (crashes > maxCrashes) {
              console.error('‚ùå Too many crashes detected');
              process.exit(1);
            }
            
            if (hangs > maxHangs) {
              console.error('‚ùå Too many hangs detected');
              process.exit(1);
            }
            
            if (coverage < minCoverage) {
              console.error('‚ùå Coverage too low');
              process.exit(1);
            }
            
            console.log('‚úÖ All fuzzing thresholds passed');
          } catch (error) {
            console.error('Failed to evaluate thresholds:', error);
            process.exit(1);
          }
          "

  notify:
    needs: fuzz
    if: failure()
    runs-on: ubuntu-latest
    
    steps:
      - name: Notify security team
        uses: actions/github-script@v7
        with:
          script: |
            // Send notification to security team about fuzzing failures
            // This would integrate with your notification system
            console.log('Fuzzing failed - security team notified');
