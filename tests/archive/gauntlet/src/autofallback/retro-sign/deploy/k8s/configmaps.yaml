# Kubernetes ConfigMaps - ENTERPRISE CONFIGURATION
# 
# Production configuration with environment-specific settings
# Includes application config, monitoring, and security policies
# 
# SECURITY REQUIREMENTS:
# - No secrets in configmaps
# - Environment separation
# - Immutable configurations
# - Version-controlled settings

apiVersion: v1
kind: ConfigMap
metadata:
  name: keyctl-config
  namespace: credlink
  labels:
    app: keyctl
    component: configuration
    version: v1.0.0
  annotations:
    description: "C2-Concierge Key Custody Configuration"
data:
  # Main application configuration
  signer-hsm.toml: |
    # Production Configuration - ENTERPRISE GRADE
    # This configuration is optimized for production security and performance
    
    [database]
    url = "${DATABASE_URL}"
    max_connections = 20
    connection_timeout = 30
    idle_timeout = 600
    
    [logging]
    level = "info"
    format = "json"
    file = "/opt/keyctl/logs/keyctl.log"
    max_file_size = "100MB"
    max_files = 10
    
    [security]
    require_https = true
    session_timeout = 3600
    max_login_attempts = 5
    lockout_duration = 900
    
    [rotation]
    default_interval_days = 30
    advance_warning_days = 7
    canary_count = 100
    cutover_timeout_minutes = 30
    
    [monitoring]
    metrics_enabled = true
    health_check_interval = 30
    alert_webhook = "${ALERT_WEBHOOK_URL}"
    
    [hsm.yubihsm2]
    enabled = true
    connector_url = "http://yubihsm-connector:8080"
    auth_key_id = 1
    timeout = 30
    
    [hsm.vault]
    enabled = true
    addr = "http://vault:8200"
    mount_path = "transit"
    timeout = 30
    
    [kms.aws]
    enabled = true
    region = "us-west-2"
    timeout = 30
    
    [kms.gcp]
    enabled = true
    project_id = "${GCP_PROJECT_ID}"
    location = "us-west2"
    timeout = 30
    
  # Nginx configuration
  nginx.conf: |
    upstream keyctl {
        server keyctl:8080;
    }
    
    upstream grafana {
        server grafana:3000;
    }
    
    server {
        listen 80;
        server_name _;
        return 301 https://$server_name$request_uri;
    }
    
    server {
        listen 443 ssl http2;
        server_name _;
        
        ssl_certificate /etc/nginx/ssl/tls.crt;
        ssl_certificate_key /etc/nginx/ssl/tls.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        
        # Security headers
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
        
        # Rate limiting
        limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
        limit_req zone=api burst=20 nodelay;
        
        # API endpoints
        location /api/ {
            proxy_pass http://keyctl;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_connect_timeout 30;
            proxy_send_timeout 30;
            proxy_read_timeout 30;
        }
        
        # Health check
        location /health {
            proxy_pass http://keyctl;
            access_log off;
        }
        
        # Grafana dashboard
        location /grafana/ {
            proxy_pass http://grafana/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
  
  # Prometheus configuration
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
    
    rule_files:
      - "/etc/prometheus/rules/*.yml"
    
    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093
    
    scrape_configs:
      - job_name: 'keyctl'
        static_configs:
          - targets: ['keyctl:9090']
        metrics_path: /metrics
        scrape_interval: 15s
        
      - job_name: 'postgres'
        static_configs:
          - targets: ['postgres-exporter:9187']
        scrape_interval: 30s
        
      - job_name: 'vault'
        static_configs:
          - targets: ['vault:9102']
        scrape_interval: 30s
        
      - job_name: 'redis'
        static_configs:
          - targets: ['redis-exporter:9121']
        scrape_interval: 30s
  
  # Grafana dashboards
  dashboards.yml: |
    apiVersion: 1
    
    providers:
      - name: 'keyctl-dashboards'
        orgId: 1
        folder: 'C2-Concierge'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /etc/grafana/provisioning/dashboards
  
  # Alert rules
  alert-rules.yml: |
    groups:
      - name: keyctl.rules
        rules:
          - alert: KeyctlDown
            expr: up{job="keyctl"} == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "Keyctl service is down"
              description: "Keyctl service has been down for more than 1 minute"
          
          - alert: HighErrorRate
            expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "High error rate detected"
              description: "Error rate is {{ $value }} errors per second"
          
          - alert: RotationFailure
            expr: rotation_failures_total > 0
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: "Key rotation failure"
              description: "Key rotation has failed {{ $value }} times"
          
          - alert: HSMUnavailable
            expr: hsm_health_status == 0
            for: 1m
            labels:
              severity: critical
            annotations:
              summary: "HSM is unavailable"
              description: "HSM device is not responding"
  
  # Backup script
  backup.sh: |
    #!/bin/bash
    set -euo pipefail
    
    # Configuration
    BACKUP_DIR="/backups"
    TIMESTAMP=$(date +%Y%m%d-%H%M%S)
    RETENTION_DAYS=30
    
    # Create backup directory
    mkdir -p "${BACKUP_DIR}"
    
    # Database backup
    echo "Creating database backup..."
    pg_dump -h postgres -U keyctl keyctl | gzip > "${BACKUP_DIR}/keyctl-db-${TIMESTAMP}.sql.gz"
    
    # Configuration backup
    echo "Creating configuration backup..."
    tar -czf "${BACKUP_DIR}/keyctl-config-${TIMESTAMP}.tar.gz" /opt/keyctl/config/
    
    # Rotation evidence packs backup
    echo "Creating REP backup..."
    tar -czf "${BACKUP_DIR}/keyctl-rep-${TIMESTAMP}.tar.gz" /opt/keyctl/rep-output/
    
    # Cleanup old backups
    echo "Cleaning up old backups..."
    find "${BACKUP_DIR}" -name "*.gz" -mtime +${RETENTION_DAYS} -delete
    
    # Verify backup
    echo "Verifying backup..."
    if [ -f "${BACKUP_DIR}/keyctl-db-${TIMESTAMP}.sql.gz" ]; then
      echo "Backup completed successfully: ${TIMESTAMP}"
    else
      echo "Backup failed!"
      exit 1
    fi
  
  # Health check script
  health-check.sh: |
    #!/bin/bash
    set -euo pipefail
    
    # Check application health
    if curl -f http://localhost:8080/health > /dev/null 2>&1; then
      echo "Application is healthy"
      exit 0
    else
      echo "Application is unhealthy"
      exit 1
    fi
  
  # Log rotation
  logrotate.conf: |
    /opt/keyctl/logs/*.log {
      daily
      rotate 30
      compress
      delaycompress
      missingok
      notifempty
      create 644 keyctl keyctl
      postrotate
        kill -USR1 $(cat /var/run/keyctl.pid 2>/dev/null) 2>/dev/null || true
      endscript
    }
