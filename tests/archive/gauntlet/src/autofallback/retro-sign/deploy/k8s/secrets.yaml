# Kubernetes Secrets - ENTERPRISE SECURITY
# 
# Sensitive configuration with proper encryption
# Includes database credentials, API keys, and certificates
# 
# SECURITY REQUIREMENTS:
# - Encrypted at rest
# - Least privilege access
# - Regular rotation
# - Audit logging

apiVersion: v1
kind: Secret
metadata:
  name: keyctl-secrets
  namespace: credlink
  labels:
    app: keyctl
    component: secrets
    version: v1.0.0
  annotations:
    description: "C2-Concierge Key Custody Secrets"
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/role: "keyctl"
type: Opaque
data:
  # Database connection (base64 encoded)
  # Example: postgresql://keyctl:password@postgres:5432/keyctl
  database-url: cG9zdGdyZXNxbDovL2tleWN0bDpTRUNSRVRfUEFTU1dPUkRAcG9zdGdyZXM6NTQzMi9rZXljdGw=
  
  # Vault token (base64 encoded)
  vault-token: dmF1bHRfcm9vdF90b2tlbl9TRUNSRVQ=
  
  # AWS credentials (base64 encoded)
  aws-access-key: QVdTX0FDQ0VTU19LRVk=
  aws-secret-key: QVdTX1NFQ1JFVF9LRVk=
  
  # GCP credentials (base64 encoded JSON)
  gcp-credentials: eyJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsICJwcm9qZWN0X2lkIjogImdwYy1wcm9qZWN0LWlkIiwgInByaXZhdGVfa2V5X2lkIjogInByaXZhdGUta2V5LWlkIiwgInByaXZhdGVfa2V5IjogIi0tLS0tQkVHSU4gUFJJVkFURSBLRVktLS0tLSJ9
  
  # Alert webhook URL (base64 encoded)
  alert-webhook-url: aHR0cHM6Ly9ob29rcy5zbGFjay5jb20vc2VydmljZXMvVDEyM0JDS0VVL0IwMTIzNDU2
  
  # Grafana admin password (base64 encoded)
  grafana-password: R1JBRkFOQV9QQVNTV09SRF9TRUNSRVQ=
  
  # TLS certificate (base64 encoded)
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCi4uLiBDRVJUSUZJQ0FURS0tLS0tCg==
  
  # TLS private key (base64 encoded)
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCi4uLiBQUklWQVRFIEtFWS0tLS0tCg==
  
  # HSM PIN (base64 encoded)
  hsm-pin: SFNNX1BJTl9TRUNSRVQ=
  
  # Encryption key for sensitive data at rest (base64 encoded)
  encryption-key: RU5DUllQVElPTl9LRVlfMzJfQllURVM=
---
# Service Account - Identity for pods
apiVersion: v1
kind: ServiceAccount
metadata:
  name: keyctl
  namespace: credlink
  labels:
    app: keyctl
    component: service-account
  annotations:
    description: "Service account for C2-Concierge pods"
    iam.amazonaws.com/role: "arn:aws:iam::ACCOUNT:role/keyctl-k8s-role"
---
# Role - Permissions within namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: keyctl-role
  namespace: credlink
  labels:
    app: keyctl
    component: rbac
  annotations:
    description: "Role for C2-Concierge service account"
rules:
- apiGroups: [""]
  resources: ["configmaps", "secrets"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
- apiGroups: ["apps"]
  resources: ["deployments", "replicasets"]
  verbs: ["get", "list"]
---
# RoleBinding - Attach role to service account
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keyctl-rolebinding
  namespace: credlink
  labels:
    app: keyctl
    component: rbac
  annotations:
    description: "Role binding for C2-Concierge service account"
subjects:
- kind: ServiceAccount
  name: keyctl
  namespace: credlink
roleRef:
  kind: Role
  name: keyctl-role
  apiGroup: rbac.authorization.k8s.io
---
# ClusterRole - Cluster-wide permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: keyctl-clusterrole
  labels:
    app: keyctl
    component: rbac
  annotations:
    description: "Cluster role for C2-Concierge monitoring"
rules:
- apiGroups: [""]
  resources: ["nodes", "pods", "services", "endpoints"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["metrics.k8s.io"]
  resources: ["pods", "nodes"]
  verbs: ["get", "list"]
---
# ClusterRoleBinding - Attach cluster role
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: keyctl-clusterrolebinding
  labels:
    app: keyctl
    component: rbac
  annotations:
    description: "Cluster role binding for C2-Concierge monitoring"
subjects:
- kind: ServiceAccount
  name: keyctl
  namespace: credlink
roleRef:
  kind: ClusterRole
  name: keyctl-clusterrole
  apiGroup: rbac.authorization.k8s.io
---
# External Secret - AWS Secrets Manager integration
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: keyctl-secret-store
  namespace: credlink
spec:
  provider:
    aws:
      service: SecretsManager
      region: us-west-2
      auth:
        jwt:
          serviceAccountRef:
            name: keyctl
---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: keyctl-external-secrets
  namespace: credlink
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: keyctl-secret-store
    kind: SecretStore
  target:
    name: keyctl-dynamic-secrets
    creationPolicy: Owner
  data:
  - secretKey: database-password
    remoteRef:
      key: keyctl/database-password
  - secretKey: vault-token
    remoteRef:
      key: keyctl/vault-token
---
# Certificate for TLS
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: keyctl-tls
  namespace: credlink
  labels:
    app: keyctl
    component: certificate
  annotations:
    description: "TLS certificate for C2-Concierge"
spec:
  secretName: keyctl-tls-secret
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
  - keyctl.credlink.com
  - api.keyctl.credlink.com
---
# Issuer for certificates
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
  labels:
    app: keyctl
    component: certificate-issuer
  annotations:
    description: "Let's Encrypt certificate issuer"
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@credlink.com
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx
---
# Network Policy for secrets access
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: keyctl-secrets-policy
  namespace: credlink
  annotations:
    description: "Network policy for secrets access"
spec:
  podSelector:
    matchLabels:
      app: keyctl
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: TCP
      port: 443
    - protocol: TCP
      port: 53
    - protocol: UDP
      port: 53
  - to:
    - podSelector:
        matchLabels:
          app: postgres
    ports:
    - protocol: TCP
      port: 5432
  - to:
    - podSelector:
        matchLabels:
          app: vault
    ports:
    - protocol: TCP
      port: 8200
