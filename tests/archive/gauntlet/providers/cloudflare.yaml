provider: cloudflare
name: "Cloudflare"
products: ["Resizing", "Polish"]
base_url: "https://cf.survival.test"
documentation:
  resizing: "https://developers.cloudflare.com/images/image-resizing/"
  polish: "https://developers.cloudflare.com/images/polish/"
last_updated: "2025-10-30"
notes: |
  Cloudflare Resizing + Polish behavior (as of 2025-10-30):
  
  • Polish strips metadata by design for size/privacy optimization
  • Resizing supports metadata=none|copyright|keep options
  • WebP/PNG conversions discard EXIF even with metadata=keep
  • Content Credentials preservation requires zone toggle "Preserve Content Credentials"
  • Default JPEG metadata=copyright keeps basic copyright info only
  • Transformations override preservation settings
  
  References:
  - https://developers.cloudflare.com/images/image-resizing/format-and-quality/#metadata
  - https://developers.cloudflare.com/images/polish/

routes:
  - id: preserve-embed
    description: "Preserve embeds with metadata=keep and Content Credentials toggle"
    url_pattern: "/cdn-cgi/image/{transform_options}/{origin_url}"
    default_params:
      metadata: "keep"
    transform_mappings:
      resize_1024:
        width: 1024
      q_75:
        quality: 75
      format_webp:
        format: "auto"
      format_avif:
        format: "auto"
      crop_1x1_center:
        width: 1024
        height: 1024
        fit: "cover"
      progressive_jpeg:
        format: "auto"
      rotate_90:
        rotate: 90
      sharpen:
        sharpen: 1
      gamma:
        gamma: 1.2
        contrast: 1.1
      png_to_jpg:
        format: "auto"
      dpr_2:
        dpr: 2
      provider_auto_optimize:
        format: "auto"
        quality: 75
    special_config:
      zone_settings:
        preserve_content_credentials: true
        polish: "on"
      caveats:
        - "WebP/PNG discard EXIF even with metadata=keep"
        - "Content Credentials toggle must be enabled in zone"
        - "Polish may override metadata settings"

  - id: strip-happy
    description: "Aggressive transforms with metadata=none and Polish active"
    url_pattern: "/cdn-cgi/image/{transform_options}/{origin_url}"
    default_params:
      metadata: "none"
      format: "auto"
      quality: 75
    transform_mappings:
      resize_1024:
        width: 1024
      q_75:
        quality: 75
      format_webp:
        format: "auto"
      format_avif:
        format: "auto"
      crop_1x1_center:
        width: 1024
        height: 1024
        fit: "cover"
      progressive_jpeg:
        format: "auto"
      rotate_90:
        rotate: 90
      sharpen:
        sharpen: 1
      gamma:
        gamma: 1.2
        contrast: 1.1
      png_to_jpg:
        format: "auto"
      dpr_2:
        dpr: 2
      provider_auto_optimize:
        format: "auto"
        quality: 75
    special_config:
      zone_settings:
        polish: "on"
        preserve_content_credentials: false
      expected_behavior:
        embed_survival: false
        remote_survival: true
        reason: "Polish strips metadata, format conversion removes EXIF"

  - id: remote-only
    description: "Remote manifest only via Edge Worker injection"
    url_pattern: "/cdn-cgi/image/{transform_options}/{origin_url}"
    default_params:
      metadata: "none"
    transform_mappings:
      resize_1024:
        width: 1024
      q_75:
        quality: 75
      format_webp:
        format: "auto"
      format_avif:
        format: "auto"
      crop_1x1_center:
        width: 1024
        height: 1024
        fit: "cover"
      progressive_jpeg:
        format: "auto"
      rotate_90:
        rotate: 90
      sharpen:
        sharpen: 1
      gamma:
        gamma: 1.2
        contrast: 1.1
      png_to_jpg:
        format: "auto"
      dpr_2:
        dpr: 2
      provider_auto_optimize:
        format: "auto"
        quality: 75
    special_config:
      edge_worker:
        inject_manifest_link: true
        fallback_html: true
      expected_behavior:
        embed_survival: false
        remote_survival: true
        reason: "Edge Worker ensures remote manifest link injection"

headers:
  test:
    User-Agent: "C2C-Gauntlet/1.0"
    Accept: "image/*,*/*;q=0.8"
  expected:
    Link: 'rel="c2pa-manifest"'
    Cache-Control: "public, max-age=31536000, immutable"
    ETag: "*"

probes:
  remote:
    method: "header_link"
    fallback: "html_link"
    verification: "hash_alignment"
  embed:
    method: "c2patool_verify"
    expected_on_routes: ["preserve-embed"]
    failure_expected_on_routes: ["strip-happy", "remote-only"]
