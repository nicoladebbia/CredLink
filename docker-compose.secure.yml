# S-14: Secure Docker Compose Configuration

version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.secure
    
    # S-14: Security hardening
    security_opt:
      - no-new-privileges:true
      - apparmor=docker-default
      - seccomp=seccomp-profile.json
    
    # Run as non-root user
    user: "1001:1001"
    
    # Read-only root filesystem
    read_only: true
    
    # Temporary filesystem for /tmp
    tmpfs:
      - /tmp:mode=1777,size=100M
      - /app/logs:mode=0755,uid=1001,gid=1001
    
    # Drop all capabilities, add only necessary ones
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
          pids: 100
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Restart policy
    restart: unless-stopped
    
    # Environment variables (load from secrets)
    env_file:
      - .env.production
    environment:
      NODE_ENV: production
      LOG_LEVEL: info
    
    # Volumes (minimal, specific)
    volumes:
      - ./certs:/app/certs:ro
      - logs:/app/logs
      - temp:/app/temp
    
    # Network
    networks:
      - credlink-network
    
    ports:
      - "3000:3000"
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  redis:
    image: redis:7-alpine
    
    # S-14: Security hardening
    security_opt:
      - no-new-privileges:true
    
    user: "999:999"
    read_only: true
    
    cap_drop:
      - ALL
    
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
    
    restart: unless-stopped
    
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
    
    volumes:
      - redis-data:/data
    
    networks:
      - credlink-network
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 3s
      retries: 3

networks:
  credlink-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  logs:
    driver: local
  temp:
    driver: local
  redis-data:
    driver: local
