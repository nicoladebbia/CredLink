apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: auth-service-policy
  namespace: c2c-enterprise
spec:
  selector:
    matchLabels:
      app: auth-service
  action: ALLOW
  rules:
  # Allow health checks from monitoring
  - from:
    - source:
        principals: ["cluster.local/ns/monitoring/sa/prometheus"]
    to:
    - operation:
        methods: ["GET"]
        paths: ["/health", "/ready", "/metrics"]
  # Allow requests from API gateway
  - from:
    - source:
        principals: ["cluster.local/ns/c2c-enterprise/sa/api-gateway"]
    to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE"]
        paths: ["/api/auth/*"]
  # Allow requests from admin service
  - from:
    - source:
        principals: ["cluster.local/ns/c2c-enterprise/sa/admin-service"]
    to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE"]
        paths: ["/api/auth/*"]
  # Allow mTLS between services
  - from:
    - source:
        principals: ["cluster.local/ns/c2c-enterprise/*"]
  when:
  - key: request.headers[authorization]
    values: ["Bearer *"]

---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: webhook-service-policy
  namespace: c2c-enterprise
spec:
  selector:
    matchLabels:
      app: webhook-service
  action: ALLOW
  rules:
  # Allow health checks from monitoring
  - from:
    - source:
        principals: ["cluster.local/ns/monitoring/sa/prometheus"]
    to:
    - operation:
        methods: ["GET"]
        paths: ["/health", "/ready", "/metrics"]
  # Allow Shopify webhook requests
  - from:
    - source:
        requestPrincipals: ["*"]
    to:
    - operation:
        methods: ["POST"]
        paths: ["/webhooks/*"]
    when:
    - key: request.headers[x-shopify-hmac-sha256]
      values: ["*"]
    - key: request.headers[x-shopify-topic]
      values: ["*"]
    - key: request.headers[x-shopify-shop-domain]
      values: ["*"]
  # Allow requests from internal services
  - from:
    - source:
        principals: ["cluster.local/ns/c2c-enterprise/*"]

---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: signing-service-policy
  namespace: c2c-enterprise
spec:
  selector:
    matchLabels:
      app: signing-service
  action: ALLOW
  rules:
  # Allow health checks from monitoring
  - from:
    - source:
        principals: ["cluster.local/ns/monitoring/sa/prometheus"]
    to:
    - operation:
        methods: ["GET"]
        paths: ["/health", "/ready", "/metrics"]
  # Allow requests from webhook service
  - from:
    - source:
        principals: ["cluster.local/ns/c2c-enterprise/sa/webhook-service"]
    to:
    - operation:
        methods: ["POST"]
        paths: ["/api/signing/*"]
  # Allow requests from admin service
  - from:
    - source:
        principals: ["cluster.local/ns/c2c-enterprise/sa/admin-service"]
    to:
    - operation:
        methods: ["GET", "POST"]
        paths: ["/api/signing/*"]

---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: admin-service-policy
  namespace: c2c-enterprise
spec:
  selector:
    matchLabels:
      app: admin-service
  action: ALLOW
  rules:
  # Allow health checks from monitoring
  - from:
    - source:
        principals: ["cluster.local/ns/monitoring/sa/prometheus"]
    to:
    - operation:
        methods: ["GET"]
        paths: ["/health", "/ready", "/metrics"]
  # Allow requests from authenticated users
  - from:
    - source:
        requestPrincipals: ["*"]
    to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE"]
        paths: ["/api/admin/*"]
    when:
    - key: request.auth.claims[role]
      values: ["admin", "super_admin"]
    - key: request.auth.claims[permissions]
      values: ["admin:access"]

---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: deny-all-external
  namespace: c2c-enterprise
spec:
  selector:
    matchLabels:
      app: auth-service
  action: DENY
  rules:
  - from:
    - source:
        notPrincipals: ["cluster.local/*"]
  - to:
    - operation:
        notPaths: ["/health", "/ready", "/metrics"]

---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: rate-limit-auth
  namespace: c2c-enterprise
spec:
  selector:
    matchLabels:
      app: auth-service
  action: ALLOW
  rules:
  - from:
    - source:
        requestPrincipals: ["*"]
    to:
    - operation:
        methods: ["POST"]
        paths: ["/api/auth/login", "/api/auth/register"]
    when:
    - key: destination.labels["app"]
      values: ["auth-service"]
  - from:
    - source:
        requestPrincipals: ["*"]
    to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE"]
        paths: ["/api/auth/*"]

---
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: default
  namespace: c2c-enterprise
spec:
  mtls:
    mode: STRICT

---
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: jwt-authentication
  namespace: c2c-enterprise
spec:
  selector:
    matchLabels:
      app: auth-service
  jwtRules:
  - issuer: "https://c2concierge.com"
    jwksUri: "https://c2concierge.com/.well-known/jwks.json"
    forwardOriginalToken: true
    fromHeaders:
    - name: "authorization"
      prefix: "Bearer "
    outputPayloadToHeader: "x-jwt-payload"

---
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: shopify-webhook-auth
  namespace: c2c-enterprise
spec:
  selector:
    matchLabels:
      app: webhook-service
  jwtRules:
  - issuer: "https://shops.myshopify.com"
    jwksUri: "https://shops.myshopify.com/.well-known/jwks.json"
    fromHeaders:
    - name: "x-shopify-shop-domain"
    - name: "x-shopify-hmac-sha256"
    - name: "x-shopify-topic"

---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: auth-service-mtls
  namespace: c2c-enterprise
spec:
  host: auth-service
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    portLevelSettings:
    - port:
        number: 3001
      tls:
        mode: ISTIO_MUTUAL
    loadBalancer:
      simple: LEAST_CONN
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 50
        maxRequestsPerConnection: 10
    circuitBreaker:
      consecutiveErrors: 3
      interval: 30s
      baseEjectionTime: 30s

---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: webhook-service-mtls
  namespace: c2c-enterprise
spec:
  host: webhook-service
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    portLevelSettings:
    - port:
        number: 3002
      tls:
        mode: ISTIO_MUTUAL
    loadBalancer:
      simple: ROUND_ROBIN
    connectionPool:
      tcp:
        maxConnections: 50
      http:
        http1MaxPendingRequests: 25
        maxRequestsPerConnection: 5
    circuitBreaker:
      consecutiveErrors: 3
      interval: 30s
      baseEjectionTime: 30s

---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: signing-service-mtls
  namespace: c2c-enterprise
spec:
  host: signing-service
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    portLevelSettings:
    - port:
        number: 3003
      tls:
        mode: ISTIO_MUTUAL
    loadBalancer:
      simple: LEAST_CONN
    connectionPool:
      tcp:
        maxConnections: 200
      http:
        http1MaxPendingRequests: 100
        maxRequestsPerConnection: 20
    circuitBreaker:
      consecutiveErrors: 3
      interval: 30s
      baseEjectionTime: 30s

---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: admin-service-mtls
  namespace: c2c-enterprise
spec:
  host: admin-service
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
    portLevelSettings:
    - port:
        number: 3004
      tls:
        mode: ISTIO_MUTUAL
    loadBalancer:
      simple: ROUND_ROBIN
    connectionPool:
      tcp:
        maxConnections: 25
      http:
        http1MaxPendingRequests: 10
        maxRequestsPerConnection: 5
    circuitBreaker:
      consecutiveErrors: 3
      interval: 30s
      baseEjectionTime: 30s

---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-monitoring
  namespace: c2c-enterprise
spec:
  selector:
    matchLabels:
      app: auth-service
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/monitoring/sa/prometheus"]
    to:
    - operation:
        methods: ["GET"]
        paths: ["/metrics", "/health", "/ready"]

---
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: allow-tracing
  namespace: c2c-enterprise
spec:
  selector:
    matchLabels:
      app: auth-service
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/istio-system/sa/istio-ingressgateway-service-account"]
    to:
    - operation:
        methods: ["POST"]
        paths: ["/api/traces/*"]

---
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: external-c2c-api
  namespace: c2c-enterprise
spec:
  hosts:
  - api.c2concierge.com
  ports:
  - number: 443
    name: https
    protocol: HTTPS
  location: MESH_EXTERNAL
  resolution: DNS

---
apiVersion: networking.istio.io/v1beta1
kind: ServiceEntry
metadata:
  name: external-shopify-api
  namespace: c2c-enterprise
spec:
  hosts:
  - "*.myshopify.com"
  ports:
  - number: 443
    name: https
    protocol: HTTPS
  location: MESH_EXTERNAL
  resolution: DNS
