<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

  <!-- Phase 46: All migrations with reversible rollback support -->
  
  <!-- Example migration: Add canary_version column -->
  <changeSet id="phase46-001-canary-version" author="ops-team">
    <comment>Add canary version tracking for progressive delivery</comment>
    
    <!-- Forward migration -->
    <addColumn tableName="deployments">
      <column name="canary_version" type="varchar(64)">
        <constraints nullable="true"/>
      </column>
      <column name="traffic_percentage" type="int" defaultValue="0">
        <constraints nullable="false"/>
      </column>
    </addColumn>
    
    <!-- Rollback (automatically generated by Liquibase) -->
    <rollback>
      <dropColumn tableName="deployments" columnName="canary_version"/>
      <dropColumn tableName="deployments" columnName="traffic_percentage"/>
    </rollback>
  </changeSet>

  <!-- Example migration: Add feature flags table -->
  <changeSet id="phase46-002-feature-flags" author="ops-team">
    <comment>Create feature flags table for progressive delivery</comment>
    
    <createTable tableName="feature_flags">
      <column name="id" type="uuid" defaultValueComputed="gen_random_uuid()">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="key" type="varchar(255)">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="enabled" type="boolean" defaultValue="false">
        <constraints nullable="false"/>
      </column>
      <column name="description" type="text"/>
      <column name="owner" type="varchar(255)">
        <constraints nullable="false"/>
      </column>
      <column name="created_at" type="timestamp" defaultValueComputed="now()">
        <constraints nullable="false"/>
      </column>
      <column name="expires_at" type="timestamp">
        <constraints nullable="false"/>
      </column>
      <column name="targeting_config" type="jsonb"/>
    </createTable>
    
    <createIndex tableName="feature_flags" indexName="idx_feature_flags_key">
      <column name="key"/>
    </createIndex>
    
    <createIndex tableName="feature_flags" indexName="idx_feature_flags_expires_at">
      <column name="expires_at"/>
    </createIndex>
    
    <rollback>
      <dropTable tableName="feature_flags"/>
    </rollback>
  </changeSet>

  <!-- Example: Backward-compatible schema change -->
  <changeSet id="phase46-003-add-release-metadata" author="ops-team">
    <comment>Add release metadata for incident correlation (backward compatible)</comment>
    
    <!-- Add nullable column first (safe for rollback) -->
    <addColumn tableName="audit_logs">
      <column name="release_sha" type="varchar(64)">
        <constraints nullable="true"/>
      </column>
      <column name="deployment_id" type="varchar(64)">
        <constraints nullable="true"/>
      </column>
    </addColumn>
    
    <!-- Add index -->
    <createIndex tableName="audit_logs" indexName="idx_audit_logs_release_sha">
      <column name="release_sha"/>
    </createIndex>
    
    <rollback>
      <dropIndex tableName="audit_logs" indexName="idx_audit_logs_release_sha"/>
      <dropColumn tableName="audit_logs" columnName="release_sha"/>
      <dropColumn tableName="audit_logs" columnName="deployment_id"/>
    </rollback>
  </changeSet>

  <!-- Tag for phase completion -->
  <changeSet id="phase46-tag" author="ops-team">
    <tagDatabase tag="phase46-complete"/>
  </changeSet>

</databaseChangeLog>
