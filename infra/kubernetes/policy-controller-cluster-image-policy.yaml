apiVersion: policy.sigstore.dev/v1alpha1
kind: ClusterImagePolicy
metadata:
  name: require-signed-and-provenance-maximum-security
  annotations:
    description: "Maximum security policy requiring signed images with comprehensive SLSA provenance, SBOM, and vulnerability attestations for C2 Concierge"
    policy.sigstore.dev/category: "supply-chain-security"
    policy.sigstore.dev/severity: "critical"
    policy.sigstore.dev/status: "production"
    policy.sigstore.dev/version: "2.0.0"
spec:
  # Maximum security: Restrict to exact repository with precise pattern matching
  images:
    - glob: "ghcr.io/nickiller04/credlink:*"
      # Security: Exact repository match to prevent scope creep and confusion
      matchLabels:
        app: "credlink"
        security.level: "maximum"
  
  # Maximum security authorities with comprehensive trust anchors
  authorities:
    - keyless:
        identities:
          # Security: Exact issuer match with no variations allowed
          - issuer: "https://token.actions.githubusercontent.com"
            # Security: Maximum restriction subject validation to prevent any identity spoofing
            subjectRegExp: "^repo:Nickiller04/credlink:ref:refs/(heads|tags)/(main|develop|v[0-9]+\\.[0-9]+\\.[0-9]+):.*$"
        # Security: Comprehensive trust anchors for maximum verification
        ctlog:
          url: "https://rekor.sigstore.dev"
          # Security: Require transparency log verification
          required: true
        tlog:
          url: "https://rekor.sigstore.dev"
          # Security: Require transparency log verification
          required: true
        # Security: Additional verification requirements
        sigstore:
          # Security: Require signature verification
          verifySignature: true
          # Security: Require certificate verification
          verifyCertificate: true
          # Security: Require transparency log verification
          verifyTransparencyLog: true
  
  # Maximum security attestations with comprehensive validation
  attestations:
    # Security: SLSA provenance with maximum validation requirements
    - name: slsa-provenance-maximum
      predicateType: "https://slsa.dev/provenance/v1"
      required: true
      policy:
        type: CUE
        data: |
          import "strings"
          import "regexp"
          import "time"

          predicate: {
            # Security: Exact build type validation to prevent build system spoofing
            buildType: =~ "^https://github.com/actions/runner-container-images@v[0-9]+\\.[0-9]+\\.[0-9]+$"
            # Security: Exact builder ID validation with maximum restrictions
            builder: {
              id: =~ "^https://github.com/Nickiller04/credlink/\\.github/workflows/build-sign-attest\\.yml@[a-f0-9]{40,64}$"
            }
            # Security: Comprehensive materials validation to prevent supply chain injection
            materials: [{
              # Security: Exact repository URI with no variations
              uri: =~ "^git\\+https://github.com/Nickiller04/credlink\\.git$"
              # Security: Require SHA256 digest for reproducibility
              digest: =~ "^sha256:[a-f0-9]{64}$"
              # Security: Validate material is from main or develop branch
              annotations: {
                "git.branch": =~ "^(main|develop)$"
              }
            }]
            # Security: Maximum build environment validation
            invocation: {
              # Security: Exact configuration source validation
              configSource: {
                uri: =~ "^git\\+https://github.com/Nickiller04/credlink\\.git$"
                digest: =~ "^sha256:[a-f0-9]{64}$"
                # Security: Exact entry point validation
                entryPoint: =~ "^\\.github/workflows/build-sign-attest\\.yml@refs/(heads|tags)/(main|develop|v[0-9]+\\.[0-9]+\\.[0-9]+)$"
              }
              # Security: Validate build parameters
              parameters: {
                # Security: Require reproducible build parameters
                "SOURCE_DATE_EPOCH": =~ "^[0-9]{10}$"
                "BUILDKIT_INLINE_CACHE": "1"
              }
              # Security: Validate build environment
              environment: {
                # Security: Require secure build environment
                "NODE_ENV": "production"
                "npm_config_audit": "false"
              }
            }
            # Security: Validate build metadata
            metadata: {
              # Security: Require build completeness
              buildFinishedOn: =~ "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
              # Security: Require reproducibility metadata
              reproducible: true
            }
          }
    
    # Security: SPDX SBOM attestation with maximum validation
    - name: sbom-spdx-maximum
      predicateType: "https://spdx.dev/Document"
      required: true
      policy:
        type: CUE
        data: |
          import "regexp"
          import "time"

          predicate: {
            # Security: Exact SPDX version requirement
            spdxVersion: "SPDX-2.3"
            # Security: Require specific document naming convention
            name: =~ "^C2-Concierge-[a-f0-9]{40,64}$"
            # Security: Validate document creation with strict timestamp format
            creationInfo: {
              created: =~ "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
              # Security: Require comprehensive creators list
              creators: >= 2
              # Security: Require specific creators
              creators: ["Tool: Syft v[0-9]+\\.[0-9]+\\.[0-9]+", "Organization: C2 Concierge"]
            }
            # Security: Require comprehensive package information
            packages: >= 5
            # Security: Validate packages have required fields
            packages: [{
              # Security: Require package name
              name: =~ "^.+$"
              # Security: Require version information
              versionInfo: =~ "^.+$"
              # Security: Require license information
              licenseConcluded: =~ "^.+$"
              # Security: Require download location
              downloadLocation: =~ "^(NOASSERTION|https?://.+)$"
            }]
            # Security: Validate document namespace format
            documentNamespace: =~ "^https://spdx\\.org/spdxdocs/C2-Concierge-[a-f0-9]{40,64}-[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
            # Security: Require document descriptor
            documentDescribes: >= 1
            # Security: Require creation info completeness
            creationInfo: {
              # Security: Require license list version
              licenseListVersion: =~ "^[0-9]+\\.[0-9]+$"
            }
          }
    
    # Security: CycloneDX SBOM attestation with maximum validation
    - name: sbom-cyclonedx-maximum
      predicateType: "http://cyclonedx.org/schema/bom-1.4"
      required: true
      policy:
        type: CUE
        data: |
          import "regexp"

          predicate: {
            # Security: Exact CycloneDX version requirement
            specVersion: "1.4"
            # Security: Require exact BOM format
            bomFormat: "CycloneDX"
            # Security: Require serial number for traceability
            serialNumber: =~ "^urn:uuid:[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$"
            # Security: Require comprehensive component information
            components: >= 5
            # Security: Validate components have required fields
            components: [{
              # Security: Require component type
              type: =~ "^(library|framework|application|container)$"
              # Security: Require component name
              name: =~ "^.+$"
              # Security: Require version information
              version: =~ "^.+$"
              # Security: Require purl for package identification
              purl: =~ "^pkg:.+$"
              # Security: Require license information
              licenses: [{
                license: {
                  id: =~ "^[A-Za-z0-9\\-\\.]+$"
                }
              }]
            }]
            # Security: Require metadata
            metadata: {
              # Security: Require timestamp
              timestamp: =~ "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
              # Security: Require tools information
              tools: >= 1
              tools: [{
                # Security: Require tool information
                name: "Syft"
                version: =~ "^[0-9]+\\.[0-9]+\\.[0-9]+$"
                vendor: "Anchore"
              }]
            }
          }
    
    # Security: Comprehensive vulnerability scan attestation
    - name: vulnerability-scan-maximum
      predicateType: "https://cosign.sigstore.dev/attestation/v1"
      required: true
      policy:
        type: CUE
        data: |
          import "regexp"

          predicate: {
            # Security: Require specific scanner information
            scanner: {
              # Security: Exact scanner URI
              uri: "https://github.com/aquasecurity/trivy"
              # Security: Exact scanner version
              version: =~ "^v0\\.50\\.1$"
              # Security: Require scanner result
              result: {
                # Security: Zero tolerance for critical vulnerabilities
                critical: 0
                # Security: Limit high vulnerabilities
                high: <= 10
                # Security: Require scan completion
                scanned: true
                # Security: Require comprehensive scan
                scanners: ["vulnerability", "config", "secret"]
              }
            }
            # Security: Validate scan metadata
            metadata: {
              # Security: Require scan timestamp
              scanTime: =~ "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
              # Security: Require scan type
              scanType: "comprehensive"
              # Security: Require scan scope
              scope: "full-image"
            }
          }
    
    # Security: Additional security attestation for build verification
    - name: build-verification-maximum
      predicateType: "https://cosign.sigstore.dev/attestation/v1"
      required: true
      policy:
        type: CUE
        data: |
          import "regexp"

          predicate: {
            # Security: Require build verification data
            build: {
              # Security: Require build ID
              id: =~ "^[a-f0-9]{40,64}$"
              # Security: Require build timestamp
              timestamp: =~ "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
              # Security: Require build status
              status: "success"
              # Security: Require build duration
              duration: =~ "^[0-9]+s$"
              # Security: Require build environment
              environment: {
                # Security: Require secure environment
                runner: "ubuntu-latest"
                os: "linux"
                arch: "amd64"
              }
            }
            # Security: Require security verification
            security: {
              # Security: Require security checks
              checks: ["signature", "provenance", "sbom", "vulnerability"]
              # Security: Require all checks passed
              allPassed: true
              # Security: Require security level
              level: "maximum"
            }
          }
  
  # Security: Policy configuration with maximum restrictions
  mode: "enforce"
  # Security: Require all attestations
  matchPolicy: "all"
  # Security: Add policy metadata
  annotations:
    security.policy.level: "maximum"
    security.policy.status: "production"
    security.policy.reviewed: "true"
    security.policy.version: "2.0.0"
