# Terraform Remote State Configuration
#
# This file configures S3 backend for Terraform state storage with DynamoDB locking.
#
# SETUP INSTRUCTIONS:
# 1. Create S3 bucket for state storage:
#    aws s3api create-bucket \
#      --bucket credlink-terraform-state-${AWS_ACCOUNT_ID} \
#      --region us-east-1
#
# 2. Enable versioning on the bucket:
#    aws s3api put-bucket-versioning \
#      --bucket credlink-terraform-state-${AWS_ACCOUNT_ID} \
#      --versioning-configuration Status=Enabled
#
# 3. Enable encryption:
#    aws s3api put-bucket-encryption \
#      --bucket credlink-terraform-state-${AWS_ACCOUNT_ID} \
#      --server-side-encryption-configuration '{
#        "Rules": [{
#          "ApplyServerSideEncryptionByDefault": {
#            "SSEAlgorithm": "AES256"
#          }
#        }]
#      }'
#
# 4. Block public access:
#    aws s3api put-public-access-block \
#      --bucket credlink-terraform-state-${AWS_ACCOUNT_ID} \
#      --public-access-block-configuration \
#        BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true
#
# 5. Create DynamoDB table for state locking:
#    aws dynamodb create-table \
#      --table-name credlink-terraform-locks \
#      --attribute-definitions AttributeName=LockID,AttributeType=S \
#      --key-schema AttributeName=LockID,KeyType=HASH \
#      --billing-mode PAY_PER_REQUEST \
#      --region us-east-1
#
# 6. Copy this file to backend.tf:
#    cp backend.tf.example backend.tf
#
# 7. Update the bucket name with your AWS account ID
#
# 8. Initialize Terraform with the backend:
#    terraform init -migrate-state
#
# IMPORTANT: Add backend.tf to .gitignore if it contains sensitive values

terraform {
  backend "s3" {
    # Replace ${AWS_ACCOUNT_ID} with your actual AWS account ID
    # Example: credlink-terraform-state-123456789012
    bucket = "credlink-terraform-state-${AWS_ACCOUNT_ID}"
    
    # State file path - different for each environment
    # Production: production/terraform.tfstate
    # Staging: staging/terraform.tfstate
    # Development: development/terraform.tfstate
    key = "production/terraform.tfstate"
    
    # AWS region where the S3 bucket is located
    region = "us-east-1"
    
    # Enable server-side encryption for state file
    encrypt = true
    
    # DynamoDB table for state locking (prevents concurrent modifications)
    dynamodb_table = "credlink-terraform-locks"
    
    # Additional security options
    # acl = "private"  # Ensure state file is private
    
    # Use IAM role for authentication (recommended for production)
    # role_arn = "arn:aws:iam::${AWS_ACCOUNT_ID}:role/TerraformStateRole"
    
    # Enable workspace support for multi-environment deployments
    workspace_key_prefix = "workspaces"
  }
}

# State Locking with DynamoDB
# The DynamoDB table must have a primary key named "LockID" (case-sensitive)
# Terraform automatically creates and removes locks during operations
# If a lock gets stuck, you can manually remove it:
# aws dynamodb delete-item \
#   --table-name credlink-terraform-locks \
#   --key '{"LockID": {"S": "credlink-terraform-state-${AWS_ACCOUNT_ID}/production/terraform.tfstate"}}'
