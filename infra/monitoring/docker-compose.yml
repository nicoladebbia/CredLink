version: '3.8'

# CredLink Monitoring Stack
# Includes: Prometheus, Grafana, Alertmanager, Node Exporter
#
# Usage:
#   docker-compose up -d
#
# Access:
#   Prometheus: http://localhost:9090 (requires basic auth, see prometheus.yml)
#   Grafana: http://localhost:3000 (admin/CHANGE_ME_IN_PRODUCTION)
#   Alertmanager: http://localhost:9093 (requires basic auth)

services:
  # Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: credlink-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./alerts.yml:/etc/prometheus/alerts.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    networks:
      - monitoring

  # Grafana - Visualization (OPTIONAL - Local Development Only)
  # 
  # Production uses Grafana Cloud: https://nicolagiovannidebbia.grafana.net
  # 
  # To use Grafana Cloud instead of local Grafana:
  # 1. Configure Prometheus remote_write (see grafana-cloud.yml)
  # 2. Don't start this service: docker-compose up --scale grafana=0
  # 3. Access dashboards at: https://nicolagiovannidebbia.grafana.net
  #
  # To use local Grafana for development:
  # 1. Set GRAFANA_ADMIN_PASSWORD and GRAFANA_SECRET_KEY
  # 2. Start normally: docker-compose up
  # 3. Access at: http://localhost:3000
  grafana:
    image: grafana/grafana:latest
    container_name: credlink-grafana
    restart: unless-stopped
    profiles:
      - local-grafana  # Only start if explicitly enabled
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      # SECURITY: No default password - MUST be set via GRAFANA_ADMIN_PASSWORD env var
      # Generate strong password: openssl rand -base64 32
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:?ERROR: GRAFANA_ADMIN_PASSWORD must be set}
      - GF_USERS_ALLOW_SIGN_UP=false
      # SECURITY: Secret key MUST be set - used for signing cookies and other security features
      # Generate: openssl rand -base64 32
      - GF_SECURITY_SECRET_KEY=${GRAFANA_SECRET_KEY:?ERROR: GRAFANA_SECRET_KEY must be set}
      - GF_AUTH_ANONYMOUS_ENABLED=false
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
      # Grafana Cloud Integration (Optional)
      - GF_UNIFIED_ALERTING_ENABLED=true
      - GRAFANA_CLOUD_URL=https://nicolagiovannidebbia.grafana.net
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana-dashboard.json:/etc/grafana/provisioning/dashboards/credlink.json
      - ./grafana-datasource.yml:/etc/grafana/provisioning/datasources/prometheus.yml
    depends_on:
      - prometheus
    networks:
      - monitoring

  # Alertmanager - Alert Management
  alertmanager:
    image: prom/alertmanager:latest
    container_name: credlink-alertmanager
    restart: unless-stopped
    ports:
      - "9093:9093"
    environment:
      # SECURITY: Sensitive credentials MUST be set via environment variables
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:?ERROR: SLACK_WEBHOOK_URL must be set}
      - SMTP_USERNAME=${SMTP_USERNAME:-alerts@credlink.com}
      - SMTP_PASSWORD=${SMTP_PASSWORD:?ERROR: SMTP_PASSWORD must be set}
    volumes:
      - ./alertmanager.yml.template:/etc/alertmanager/alertmanager.yml.template
      - ./alertmanager-entrypoint.sh:/alertmanager-entrypoint.sh
      - alertmanager-data:/alertmanager
    entrypoint: ["/alertmanager-entrypoint.sh"]
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    networks:
      - monitoring

  # Node Exporter - System Metrics
  node-exporter:
    image: prom/node-exporter:latest
    container_name: credlink-node-exporter
    restart: unless-stopped
    ports:
      - "9100:9100"
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    networks:
      - monitoring

  # cAdvisor - Container Metrics (OPTIONAL - requires host access)
  # 
  # SECURITY WARNING: cAdvisor requires extensive host access to collect container metrics.
  # This creates potential security risks. Consider these alternatives:
  # 1. Use Prometheus node_exporter with Docker metrics endpoint instead
  # 2. Use cloud provider metrics (CloudWatch, Azure Monitor, GCP Monitoring)
  # 3. Disable cAdvisor entirely if not needed
  #
  # To disable: Comment out this entire service or set profile to exclude it:
  # docker-compose --profile with-cadvisor up
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: credlink-cadvisor
    restart: unless-stopped
    profiles:
      - with-cadvisor  # Only start if explicitly enabled
    ports:
      - "8080:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    # SECURITY: Running without privileged mode - may limit some metrics
    # privileged: true  # REMOVED - security risk
    # Instead, use specific capabilities
    cap_add:
      - SYS_ADMIN  # Required for cgroup access
    security_opt:
      - apparmor:unconfined  # Required for cgroup filesystem access
    devices:
      - /dev/kmsg  # Required for kernel messages
    networks:
      - monitoring

volumes:
  prometheus-data:
  grafana-data:
  alertmanager-data:

networks:
  monitoring:
    driver: bridge
